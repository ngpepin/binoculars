"use strict";var dt=Object.create;var se=Object.defineProperty;var ht=Object.getOwnPropertyDescriptor;var gt=Object.getOwnPropertyNames;var ft=Object.getPrototypeOf,mt=Object.prototype.hasOwnProperty;var pt=(o,i)=>{for(var e in i)se(o,e,{get:i[e],enumerable:!0})},Ie=(o,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let n of gt(i))!mt.call(o,n)&&n!==e&&se(o,n,{get:()=>i[n],enumerable:!(t=ht(i,n))||t.enumerable});return o};var z=(o,i,e)=>(e=o!=null?dt(ft(o)):{},Ie(i||!o||!o.__esModule?se(e,"default",{value:o,enumerable:!0}):e,o)),bt=o=>Ie(se({},"__esModule",{value:!0}),o);var Xt={};pt(Xt,{default:()=>be});module.exports=bt(Xt);var it=z(require("crypto")),x=z(require("fs")),E=z(require("path")),p=require("obsidian");var $e=z(require("child_process")),N=z(require("fs")),oe=z(require("net")),qe=z(require("os")),ae=z(require("path")),He=z(require("readline")),wt=18e4,vt=6e5,ve=9e5,yt=6e5,O=class extends Error{constructor(i,e){super(i),this.name="BridgeRpcError",this.code=e?.code,this.details=e?.details,this.method=e?.method}},Z=class o{constructor(i){this.requestSeq=1;this.pending=new Map;this.readySeen=!1;this.socketPath="";this.lastInitializeSignature="";this.output=i}async start(i,e,t){if(!(this.socket&&!this.socket.destroyed))return this.startPromise?this.startPromise:(this.startPromise=this.startInternal(i,e,t),this.startPromise)}async initialize(i,e,t,n,r,s){let c={cfg_path:i,top_k:e,text_max_tokens_override:t,observer_model_path:n,performer_model_path:r,rewrite_llm_config_path:s},a=JSON.stringify(c);a===this.lastInitializeSignature&&this.socket&&!this.socket.destroyed||(await this.request("initialize",c,vt),this.lastInitializeSignature=a)}analyzeDocument(i,e){return this.request("analyze_document",{text:i,input_label:e},ve)}analyzeChunk(i,e,t,n){return this.request("analyze_chunk",{text:i,input_label:e,start_char:t,end_char:n},ve)}analyzeNextChunk(i,e,t){return this.request("analyze_next_chunk",{text:i,input_label:e,start_char:t},ve)}estimateLiveB(i,e,t,n,r){return this.request("estimate_live_b",{text:i,input_label:e,start_char:t,end_char:n,base_cross_logxppl:r},6e5)}rewriteSpan(i,e,t,n,r=3){return this.request("rewrite_span",{text:i,span_start:e,span_end:t,option_count:r,base_metrics:n},yt)}async shutdown(){if(!this.socket||this.socket.destroyed){this.cleanupConnectionState();return}try{await this.request("shutdown",{},2e3)}catch{}this.socket.end(),this.socket.destroy(),this.cleanupConnectionState()}async shutdownDaemon(){if(this.socket&&!this.socket.destroyed){try{await this.request("shutdown_daemon",{},3e3)}catch{}this.socket.end(),this.socket.destroy(),this.cleanupConnectionState();return}let i=this.socketPath||o.defaultSocketPath(),e=new oe.Socket;await new Promise((t,n)=>{let r=!1,s=a=>{r||(r=!0,clearTimeout(c),e.removeAllListeners(),a?n(a):t())},c=setTimeout(()=>s(new Error("Timed out connecting to Binoculars daemon.")),1200);e.once("error",a=>s(a)),e.connect(i,()=>{let a={id:1,method:"shutdown_daemon",params:{}};e.write(JSON.stringify(a)+`
`,"utf8",()=>{e.end(),s()})})}).catch(()=>{})}dispose(){this.shutdown()}async startInternal(i,e,t){let n=o.defaultSocketPath();if(this.socketPath=n,!await this.tryConnect(n,1200)){try{N.existsSync(n)&&N.unlinkSync(n)}catch{}if(this.spawnDaemonProcess(i,e,n,t),!await this.waitForDaemon(n,12e3))throw this.startPromise=void 0,new Error(`Timed out waiting for Binoculars daemon socket at ${n}`);if(!await this.waitForConnect(n,12e3,1200)){try{N.existsSync(n)&&N.unlinkSync(n)}catch{}if(this.spawnDaemonProcess(i,e,n,t),!(await this.waitForDaemon(n,12e3)?await this.waitForConnect(n,12e3,1200):!1))throw this.startPromise=void 0,new Error(`Unable to connect to Binoculars daemon at ${n}`)}}await this.waitForReady()}static defaultSocketPath(){let i=typeof process.getuid=="function"?String(process.getuid()):String(process.env.USER??"user");return ae.join(qe.tmpdir(),`binoculars-vscode-${i}.sock`)}spawnDaemonProcess(i,e,t,n){try{let s=ae.dirname(t);N.mkdirSync(s,{recursive:!0})}catch{}$e.spawn(i,[e,"--daemon","--socket-path",t],{stdio:"ignore",detached:!0,cwd:n,env:process.env}).unref()}async waitForDaemon(i,e){let t=Date.now()+e;for(;Date.now()<t;){if(N.existsSync(i))return!0;await new Promise(n=>setTimeout(n,100))}return N.existsSync(i)}async waitForConnect(i,e,t){let n=Date.now()+e;for(;Date.now()<n;){if(await this.tryConnect(i,t))return!0;await new Promise(s=>setTimeout(s,150))}return this.tryConnect(i,t)}async tryConnect(i,e){return this.cleanupConnectionState(),this.readySeen=!1,new Promise(t=>{let n=oe.createConnection(i),r=!1,s=a=>{r||(r=!0,clearTimeout(c),n.removeAllListeners("error"),n.removeAllListeners("connect"),t(a))},c=setTimeout(()=>{n.destroy(),s(!1)},e);n.once("error",()=>{n.destroy(),s(!1)}),n.once("connect",()=>{this.attachSocket(n),s(!0)})})}attachSocket(i){this.socket=i,this.rl=He.createInterface({input:i}),this.rl.on("line",e=>this.onLine(e)),i.on("close",()=>{this.output("Binoculars daemon connection closed."),this.cleanupPending(new Error("Binoculars daemon connection closed.")),this.cleanupConnectionState()}),i.on("error",e=>{this.output(`Binoculars daemon socket error: ${e.message}`),this.cleanupPending(new Error("Binoculars daemon socket error.")),this.cleanupConnectionState()})}onLine(i){let e=i.trim();if(!e)return;let t;try{t=JSON.parse(e)}catch{this.output(`[bridge:raw] ${e}`),this.cleanupPending(new Error("Invalid JSON from Binoculars daemon."));return}if(t.event){if(t.event==="ready"){this.readySeen=!0,this.readyResolver?.(),this.readyResolver=void 0;return}this.output(`[bridge:event:${t.event}] ${JSON.stringify(t.payload??{})}`);return}let n=t.id;if(typeof n!="number"){this.output(`[bridge:unmatched] ${e}`);return}let r=this.pending.get(n);if(r){if(clearTimeout(r.timer),this.pending.delete(n),t.error){r.reject(new O(t.error.message,{code:t.error.code,details:t.error.details,method:r.method}));return}r.resolve(t.result)}}waitForReady(i=1e4){return this.readySeen?Promise.resolve():new Promise((e,t)=>{this.readyResolver=e,setTimeout(()=>{this.readyResolver&&(this.readyResolver=void 0,t(new Error("Timed out waiting for daemon ready event.")))},i)})}request(i,e,t=wt){if(!this.socket||this.socket.destroyed)return Promise.reject(new Error("Binoculars daemon is not connected."));let n=this.requestSeq++,r={id:n,method:i,params:e};return new Promise((s,c)=>{let a=setTimeout(()=>{this.pending.delete(n),c(new Error(`Bridge request timed out: ${i} (${Math.round(t/1e3)}s)`))},t);this.pending.set(n,{resolve:l=>s(l),reject:c,timer:a,method:i}),this.socket?.write(JSON.stringify(r)+`
`,"utf8",l=>{l&&(clearTimeout(a),this.pending.delete(n),c(l))})})}cleanupConnectionState(){this.rl?.close(),this.rl=void 0,this.socket=void 0,this.startPromise=void 0,this.readyResolver=void 0,this.readySeen=!1,this.lastInitializeSignature=""}cleanupPending(i){for(let e of this.pending.values())clearTimeout(e.timer),e.reject(i);this.pending.clear()}};var Ae=5,St=900,kt=1300,Et=900,xt=1150,Ct=!0,ye=21,W="binoculars-controls-view",ce="binoculars-owl",Mt=`
  <path d="M16.7 37.5a33.3 33.3 0 1 0 66.6 0V16.7l-12.5 8.8L50 16.7 29.2 25.5 16.7 16.7v20.8Z" stroke="currentColor" stroke-width="7.5" stroke-linecap="round" stroke-linejoin="round" fill="none"></path>
  <circle cx="37.5" cy="45.8" r="5.6" fill="currentColor"></circle>
  <circle cx="62.5" cy="45.8" r="5.6" fill="currentColor"></circle>
  <path d="M50 51.3V66.7" stroke="currentColor" stroke-width="7.5" stroke-linecap="round" fill="none"></path>
`,Pt="status.log",Rt=2*1024*1024,je=1e4,Lt="An analysis is already in progress... please refresh or return later.",le=".binoculars",_t=".json",ue=!1,Ke={enabled:!0,editorIntegrationEnabled:!1,backendPythonPath:"/home/npepin/Projects/binoculars/venv/bin/python",backendBridgeScriptPath:"/home/npepin/Projects/binoculars/vscode-extension/python/binoculars_bridge.py",configPath:"/home/npepin/Projects/binoculars/config.llama31.cuda12gb.fast.json",textMaxTokensOverride:null,topK:5,observerGgufPath:"/home/npepin/Projects/binoculars/models/Meta-Llama-3.1-8B-Q5_K_M-GGUF/meta-llama-3.1-8b-q5_k_m.gguf",performerGgufPath:"/home/npepin/Projects/binoculars/models/Meta-Llama-3.1-8B-Instruct-Q5_K_M-GGUF/meta-llama-3.1-8b-instruct-q5_k_m.gguf",externalLlmEnabled:!0,externalLlmConfigPath:"/home/npepin/Projects/binoculars/config.binoculars.llm.json",externalLlmEndpoint:"",externalLlmModel:"",externalLlmTemperature:.7,externalLlmMaxTokens:280,renderContributionBars:!0,renderColorizeText:!0,diagnosticLogging:!0};function Ge(o){return o instanceof Error?o.message:String(o??"unknown error")}function We(o){return E.resolve(o).split(E.sep).join("/")}function Ft(){let o=[],i=new Set,e=(n,r)=>{typeof r!="function"||i.has(r)||(i.add(r),o.push({source:n,req:r}))};e("global-require",globalThis.require);let t=globalThis.window;return t&&typeof t=="object"&&e("window-require",t.require),typeof require=="function"&&e("scoped-require",require),typeof module<"u"&&module&&typeof module.require=="function"&&e("module-require",module.require.bind(module)),o}function st(o){let i=[],e=`${We(E.join(__dirname,"node_modules"))}/`,t=Ft();for(let n of t)try{let r=n.req(o),s="";if(typeof n.req.resolve=="function")try{s=String(n.req.resolve(o)??"")}catch(c){i.push(`${n.source}.resolve: ${Ge(c)}`)}if(s){let c=We(s);if(c.startsWith(e)&&c.includes("/node_modules/@codemirror/")){i.push(`${n.source}: resolved to plugin-local codemirror (${s}); skipped to avoid duplicate runtime instance`);continue}}return{module:r,source:n.source,resolvedPath:s||`<unresolved:${n.source}>`,error:""}}catch(r){i.push(`${n.source}: ${Ge(r)}`)}return{module:null,source:"",resolvedPath:"",error:`Unable to resolve module ${o}. Attempts: ${i.join(" | ")}`}}var fe=st("@codemirror/state"),me=st("@codemirror/view"),pe=fe.module,B=me.module,Se=[fe.error,me.error].filter(Boolean).join(" || "),H=pe?.StateEffect.define(),Ue=pe&&H?pe.StateField.define({create:()=>0,update(o,i){for(let e of i.effects)if(e.is(H))return o+1;return o}}):void 0,Xe=B?.Decoration.mark({class:"binoculars-low-major",attributes:{style:"color: #ff4d4f !important; background-color: rgba(255, 77, 79, 0.18) !important; border-radius: 2px;"}}),Qe=B?.Decoration.mark({class:"binoculars-high-major",attributes:{style:"color: #2fbf71 !important; background-color: rgba(47, 191, 113, 0.18) !important; border-radius: 2px;"}}),At=B?.Decoration.mark({class:"binoculars-low-minor",attributes:{style:"color: var(--text-normal) !important;"}}),Bt=B?.Decoration.mark({class:"binoculars-high-minor",attributes:{style:"color: var(--text-normal) !important;"}}),Je=B?.Decoration.mark({class:"binoculars-prior-low",attributes:{style:"background-color: rgba(255, 77, 79, 0.14) !important; border-radius: 2px;"}}),Ye=B?.Decoration.mark({class:"binoculars-prior-high",attributes:{style:"background-color: rgba(47, 191, 113, 0.14) !important; border-radius: 2px;"}}),Ze=B?.Decoration.mark({class:"binoculars-unscored",attributes:{style:"color: #7d8792 !important; opacity: 0.72;"}}),et=B?.Decoration.mark({class:"binoculars-edited",attributes:{style:"background-color: rgba(255, 213, 79, 0.26) !important; border-radius: 2px;"}}),Ce=class extends p.Modal{constructor(i,e){super(i),this.message=e}openAndWait(){return new Promise(i=>{this.resolver=i,this.open()})}onOpen(){let{contentEl:i}=this;i.empty(),i.createEl("h3",{text:"Binoculars"}),i.createEl("p",{text:this.message});let e=i.createDiv({cls:"binoculars-modal-actions"}),t=e.createEl("button",{text:"Yes"}),n=e.createEl("button",{text:"No"});t.addEventListener("click",()=>{this.resolver?.(!0),this.resolver=void 0,this.close()}),n.addEventListener("click",()=>{this.resolver?.(!1),this.resolver=void 0,this.close()})}onClose(){this.resolver&&(this.resolver(!1),this.resolver=void 0),this.contentEl.empty()}},Me=class extends p.Modal{constructor(i,e,t){super(i),this.source=e,this.options=t.slice(0,3)}openAndWait(){return new Promise(i=>{this.resolver=i,this.open()})}onOpen(){let{contentEl:i}=this;i.empty(),i.createEl("h3",{text:`Binoculars Rewrite (${this.source})`}),i.createEl("p",{text:"Choose a rewrite option to apply. Keyboard: 1/2/3 apply, Q/Esc cancel."}),this.options.forEach((n,r)=>{let s=i.createDiv({cls:"binoculars-rewrite-card"}),c=s.createDiv({cls:"binoculars-rewrite-head"});c.createEl("strong",{text:`[${r+1}] ${Wt(n.approx_B,n.delta_B)}`}),c.createEl("button",{text:`Apply ${r+1}`}).addEventListener("click",()=>this.finish(n)),s.createEl("pre",{text:String(n.text||"")})}),i.createDiv({cls:"binoculars-modal-actions"}).createEl("button",{text:"Cancel"}).addEventListener("click",()=>this.finish(void 0)),this.scope.register([],"Escape",()=>(this.finish(void 0),!1)),this.scope.register([],"q",()=>(this.finish(void 0),!1)),this.scope.register([],"1",()=>(this.options[0]&&this.finish(this.options[0]),!1)),this.scope.register([],"2",()=>(this.options[1]&&this.finish(this.options[1]),!1)),this.scope.register([],"3",()=>(this.options[2]&&this.finish(this.options[2]),!1))}onClose(){this.resolver&&(this.resolver(void 0),this.resolver=void 0),this.contentEl.empty()}finish(i){if(!this.resolver)return;let e=this.resolver;this.resolver=void 0,e(i),this.close()}},Pe=class extends p.Modal{constructor(i,e){super(i),this.plugin=e}onOpen(){let{contentEl:i}=this;i.empty(),i.createEl("h3",{text:"Binoculars Status Log"}),i.createEl("p").createEl("code",{text:this.plugin.getStatusLogPath()??"<unavailable>"});let t=this.plugin.readStatusLogContents()??"<status log is empty>",n=i.createEl("pre",{text:t});n.style.maxHeight="65vh",n.style.overflow="auto";let r=i.createDiv({cls:"binoculars-modal-actions"}),s=r.createEl("button",{text:"Clear Log"}),c=r.createEl("button",{text:"Close"});s.addEventListener("click",()=>{this.plugin.clearStatusLog(),n.textContent=this.plugin.readStatusLogContents()??"<status log is empty>"}),c.addEventListener("click",()=>this.close())}onClose(){this.contentEl.empty()}},Re=class extends p.ItemView{constructor(i,e){super(i),this.plugin=e}getViewType(){return W}getDisplayText(){return"Binoculars"}getIcon(){return this.plugin.getUiIconId()}async onOpen(){this.render()}async onClose(){this.contentEl.empty()}render(){let i=this.contentEl;i.empty();let e=(d,g)=>{let u=!1,m,b=()=>{u=!1,typeof m=="number"&&(window.clearTimeout(m),m=void 0)},y=()=>{u=!0,typeof m=="number"&&window.clearTimeout(m),m=window.setTimeout(()=>{b()},1500)};d.addEventListener("pointerdown",v=>{v.button===0&&(y(),g())}),d.addEventListener("click",()=>{if(u){b();return}g()})};if(i.createEl("h3",{text:"Binoculars"}).addClass("binoculars-controls-title"),!this.plugin.isExtensionEnabled()){let d=i.createEl("button",{text:"Enable"});e(d,()=>{this.plugin.enableExtension({openControlsIfMissing:!0})});return}let n=(d,g)=>{let u=i.createEl("button",{text:d});u.addClass("binoculars-controls-btn"),e(u,()=>{this.plugin.executeControlsCommand(g)})},r=this.plugin.isControlsBlockedByInFlightAnalysis(),s=this.plugin.hasAnyAnalysisForPreferredNote(),c=this.plugin.hasAnyPriorsForPreferredNote();r?n("Refresh","binoculars-obsidian:refresh-controls"):(n(s?"Re-Analyze Chunk":"Analyze Chunk","binoculars-obsidian:analyze-chunk"),this.plugin.hasNextChunkAvailable()&&(n("Analyze Next Chunk","binoculars-obsidian:analyze-next-chunk"),n("Analyze All","binoculars-obsidian:analyze-all"))),s&&n("Rewrite Selection","binoculars-obsidian:rewrite-selection-or-line"),c&&n("Clear Priors","binoculars-obsidian:clear-priors"),s&&n(this.plugin.isRuntimeColorizationEnabled()?"Hide Colorization":"Show Colorization","binoculars-obsidian:toggle-colorization"),n("Restart Backend","binoculars-obsidian:restart-backend"),n("Show Status Log","binoculars-obsidian:show-status-log"),n("Disable","binoculars-obsidian:disable");let a=i.createDiv({cls:"binoculars-controls-status"});a.createEl("strong",{text:"Status"}),a.createEl("div",{text:this.plugin.getControlsStatusMessage()});let l=this.plugin.activeChunkCount(),h=i.createDiv({cls:"binoculars-controls-status"});h.createEl("strong",{text:"Analyzed Chunks"});let f=h.createDiv();l<=0?f.createEl("em",{text:"none"}):f.setText(String(l))}},be=class extends p.Plugin{constructor(){super(...arguments);this.settings={...Ke};this.uiIconId="telescope";this.backendStarted=!1;this.logSessionId=`${Date.now()}-${Math.floor(Math.random()*1e6)}`;this.lastStatusMessage="Binoculars Ready. Select Analyze Chunk to begin.";this.runtimeColorizationEnabled=!0;this.foregroundBusyOperationCount=0;this.docStates=new Map;this.loadedSidecarSignatures=new Map;this.liveEstimateTimers=new Map;this.liveEstimateEpochs=new Map;this.liveEstimateRecoverAttempts=new Map;this.recentTypingActivity=new Map;this.hoverSeenSegments=new Map;this.docVersions=new Map;this.lastDecorationSummaryByDoc=new Map;this.renderArtifactsByView=new WeakMap;this.lastMissingContextLogAtMs=0;this.lastUnmappedCmViewLogAtMs=0;this.statusLogWriteCount=0;this.visualsDisabledHintShown=!1}async onload(){if(await this.loadPluginSettings(),this.initializeStatusLog(),this.registerCustomIcons(),this.logStatus("plugin.onload.begin",{enabled:this.settings.enabled,vaultRoot:this.vaultBasePath()??"",pluginDir:this.pluginDirectoryPath()??""}),this.logStatus("cm.runtime.resolve",{stateSource:fe?.source??"",statePath:fe?.resolvedPath??"",viewSource:me?.source??"",viewPath:me?.resolvedPath??"",loadError:Se,cwd:process.cwd(),entryDir:__dirname}),this.statusBarEl=this.addStatusBarItem(),this.statusBarEl.addClass("binoculars-status-bar"),ue||this.statusBarEl.hide(),this.registerView(W,n=>{let r=new Re(n,this);return this.controlsView=r,r}),this.ribbonToggleEl=this.addRibbonIcon(this.uiIconId,this.currentRibbonToggleTooltip(),()=>{this.togglePluginEnablementFromRibbon()}),this.refreshRibbonToggleTooltip(),this.addCommand({id:"open-controls",name:"Binoculars: Open Controls",callback:()=>void this.openControlsView()}),this.addCommand({id:"enable",name:"Binoculars: Enable",callback:()=>void this.enableExtension({openControlsIfMissing:!0})}),this.addCommand({id:"disable",name:"Binoculars: Disable",callback:()=>void this.disableExtension()}),this.addCommand({id:"analyze-chunk",name:"Binoculars: Analyze Chunk",editorCallback:()=>void this.runAnalyze(),callback:()=>void this.runAnalyze()}),this.addCommand({id:"analyze-next-chunk",name:"Binoculars: Analyze Next Chunk",editorCallback:()=>void this.runAnalyzeNext(),callback:()=>void this.runAnalyzeNext()}),this.addCommand({id:"analyze-all",name:"Binoculars: Analyze All",editorCallback:()=>void this.runAnalyzeAll(),callback:()=>void this.runAnalyzeAll()}),this.addCommand({id:"rewrite-selection",name:"Binoculars: Rewrite Selection",editorCallback:()=>void this.runRewriteSelection(),callback:()=>void this.runRewriteSelection()}),this.addCommand({id:"rewrite-selection-or-line",name:"Binoculars: Rewrite Selection",editorCallback:()=>void this.runRewriteSelectionOrLine(),callback:()=>void this.runRewriteSelectionOrLine()}),this.addCommand({id:"clear-priors",name:"Binoculars: Clear Priors",callback:()=>this.clearPriors()}),this.addCommand({id:"toggle-colorization",name:"Binoculars: Toggle Colorization",callback:()=>this.toggleColorization()}),this.addCommand({id:"restart-backend",name:"Binoculars: Restart Backend",callback:()=>void this.restartBackend()}),this.addCommand({id:"show-status-log",name:"Binoculars: Show Status Log",callback:()=>this.showStatusLog()}),this.addCommand({id:"copy-status-log-path",name:"Binoculars: Copy Status Log Path",callback:()=>void this.copyStatusLogPath()}),this.addCommand({id:"refresh-controls",name:"Binoculars: Refresh Controls",callback:()=>this.refreshControlsAfterBusyCheck()}),this.settings.editorIntegrationEnabled)if(this.logStatus("editor-integration.register.begin"),!this.isCmRuntimeReady())this.settings.editorIntegrationEnabled=!1,this.logStatus("editor-integration.runtime-unavailable",{loadError:Se}),this.updateStatus("Loaded with editor overlays disabled (CodeMirror runtime unavailable).");else try{this.registerEditorExtension(this.buildEditorExtension()),this.logStatus("editor-integration.register.end")}catch(n){this.settings.editorIntegrationEnabled=!1,this.logStatus("editor-integration.register.error",{error:P(n)}),this.updateStatus("Loaded with editor overlays disabled (editor integration init failed). Check status.log for details.")}else this.logStatus("editor-integration.disabled");this.registerEvent(this.app.workspace.on("active-leaf-change",n=>{this.safeRun("event.active-leaf-change",()=>{let r=this.describeLeafType(n),s=this.describeLeafFile(n),c=this.describeLeafMode(n);if(this.logStatus("event.active-leaf-change",{leafType:r,file:s,mode:c}),!this.isExtensionEnabled())return;if(r!=="markdown"){this.refreshAllDecorations(),this.updateStatusForActiveEditor(),this.refreshControlsView();return}s&&(this.lastActiveMarkdownFilePath=s);let a=this.activeContext();if(this.logStatus("event.active-leaf-change.context",{hasContext:!!a,contextFile:a?.file.path??"",contextMode:this.markdownModeForView(a?.view)}),a&&this.isMarkdownSidecarEligible(a.file)){this.maybeLoadStateSidecar(a.file,a.text,"activate"),this.docStates.has(a.file.path)&&this.refreshDecorationsForFile(a.file.path),this.refreshAllDecorations(),this.updateStatusForActiveEditor(),this.refreshControlsView();return}window.setTimeout(()=>{this.safeRun("event.active-leaf-change.deferred",()=>{if(!this.isExtensionEnabled())return;let l=this.activeContext();this.logStatus("event.active-leaf-change.deferred.context",{hasContext:!!l,contextFile:l?.file.path??"",contextMode:this.markdownModeForView(l?.view),leafFile:s}),l&&this.isMarkdownSidecarEligible(l.file)?(this.maybeLoadStateSidecar(l.file,l.text,"activate"),this.docStates.has(l.file.path)&&this.refreshDecorationsForFile(l.file.path)):s&&this.docStates.has(s)&&this.refreshDecorationsForFile(s),this.refreshAllDecorations(),this.updateStatusForActiveEditor(),this.refreshControlsView()})},80)})})),this.registerEvent(this.app.workspace.on("file-open",n=>{this.safeRun("event.file-open",()=>{if(this.logStatus("event.file-open",{file:n instanceof p.TFile?n.path:"<non-file>",isMarkdown:n instanceof p.TFile?this.isMarkdownSidecarEligible(n):!1}),!this.isExtensionEnabled()||!(n instanceof p.TFile)||!this.isMarkdownSidecarEligible(n))return;this.lastOpenedMarkdownFilePath=n.path;let r=this.activeContext();this.logStatus("event.file-open.context",{hasContext:!!r,contextFile:r?.file.path??"",openedFile:n.path}),r&&r.file.path===n.path&&(this.maybeLoadStateSidecar(n,r.text,"open"),this.docStates.has(n.path)&&this.refreshDecorationsForFile(n.path),this.updateStatusForActiveEditor())})})),this.registerEvent(this.app.vault.on("modify",n=>{this.safeRun("event.vault-modify",()=>{if(!this.isExtensionEnabled()||!(n instanceof p.TFile)||!this.isMarkdownSidecarEligible(n))return;let r=this.activeContext();this.logStatus("event.vault-modify.context",{hasContext:!!r,contextFile:r?.file.path??"",modifiedFile:n.path}),r&&r.file.path===n.path&&this.autoSaveStateSidecar(n,r.text)})})),this.registerEvent(this.app.vault.on("delete",n=>{this.handleVaultDelete(n)}));let e=n=>{this.logStatus("window.error",{message:n.message,filename:n.filename,lineno:n.lineno,colno:n.colno,error:P(n.error)})},t=n=>{this.logStatus("window.unhandledrejection",{reason:P(n.reason)})};window.addEventListener("error",e),window.addEventListener("unhandledrejection",t),this.register(()=>{window.removeEventListener("error",e),window.removeEventListener("unhandledrejection",t)}),this.addSettingTab(new Le(this.app,this)),await this.applyEnablementMode(),this.logStatus("plugin.onload.end",{status:this.lastStatusMessage})}async executeCommandById(e){if(this.logStatus("command.dispatch.request",{commandId:e,hasActiveContext:!!this.activeContext()}),this.commandPrefersEditorContext(e)&&await this.ensureAnyMarkdownLeafActive(),this.isPluginOwnedCommand(e)){let s=await this.executeCommandByIdFallback(e);if(this.logStatus("command.dispatch.local",{commandId:e,handledLocally:s,hasActiveContextAfter:!!this.activeContext()}),s)return}let n=this.app.commands?.executeCommandById?.(e),r=n instanceof Promise?await n:n;if(this.logStatus("command.dispatch.result",{commandId:e,resultType:typeof r,resultBool:typeof r=="boolean"?r:void 0,hasActiveContextAfter:!!this.activeContext()}),r===!1){let s=await this.executeCommandByIdFallback(e);this.logStatus("command.dispatch.fallback",{commandId:e,fallbackApplied:s})}}async executeControlsCommand(e){this.logStatus("controls.command.request",{commandId:e,hasActiveContext:!!this.activeContext()});let t=this.controlsImmediateStatus(e);t&&this.updateStatus(t),this.commandPrefersEditorContext(e)&&await this.ensureAnyMarkdownLeafActive();let n=await this.executeCommandByIdFallback(e);this.logStatus("controls.command.result",{commandId:e,handled:n,hasActiveContextAfter:!!this.activeContext()}),n||await this.executeCommandById(e)}commandPrefersEditorContext(e){return e==="binoculars-obsidian:analyze-chunk"||e==="binoculars-obsidian:analyze-next-chunk"||e==="binoculars-obsidian:analyze-all"||e==="binoculars-obsidian:rewrite-selection"||e==="binoculars-obsidian:rewrite-selection-or-line"||e==="binoculars-obsidian:toggle-colorization"}controlsImmediateStatus(e){switch(e){case"binoculars-obsidian:rewrite-selection":case"binoculars-obsidian:rewrite-selection-or-line":return"Preparing rewrite request...";default:return}}isPluginOwnedCommand(e){return e.startsWith(`${this.manifest.id}:`)}async executeCommandByIdFallback(e){switch(e){case"binoculars-obsidian:analyze-chunk":return await this.runAnalyze(),!0;case"binoculars-obsidian:analyze-next-chunk":return await this.runAnalyzeNext(),!0;case"binoculars-obsidian:analyze-all":return await this.runAnalyzeAll(),!0;case"binoculars-obsidian:rewrite-selection":return await this.runRewriteSelection(),!0;case"binoculars-obsidian:rewrite-selection-or-line":return await this.runRewriteSelectionOrLine(),!0;case"binoculars-obsidian:clear-priors":return this.clearPriors(),!0;case"binoculars-obsidian:toggle-colorization":return this.toggleColorization(),!0;case"binoculars-obsidian:restart-backend":return await this.restartBackend(),!0;case"binoculars-obsidian:show-status-log":return this.showStatusLog(),!0;case"binoculars-obsidian:copy-status-log-path":return await this.copyStatusLogPath(),!0;case"binoculars-obsidian:refresh-controls":return this.refreshControlsAfterBusyCheck(),!0;case"binoculars-obsidian:disable":return await this.disableExtension(),!0;case"binoculars-obsidian:enable":return await this.enableExtension({openControlsIfMissing:!0}),!0;case"binoculars-obsidian:open-controls":return await this.openControlsView(),!0;default:return!1}}async ensureAnyMarkdownLeafActive(){if(this.activeContextQuiet())return;let e=this.preferredMarkdownLeaf();if(!e){this.logStatus("command.context.activate-leaf.missing");return}try{await this.app.workspace.setActiveLeaf(e,!0,!0),this.logStatus("command.context.activate-leaf.ok",{file:e.view.file?.path??""}),await this.waitForEditorContextReady(e);let t=this.activeContextQuiet()??this.anyMarkdownContextQuiet();t&&this.isMarkdownSidecarEligible(t.file)&&this.maybeLoadStateSidecar(t.file,t.text,"activate")}catch(t){this.logStatus("command.context.activate-leaf.failed",{error:P(t)})}}editorForMarkdownViewQuiet(e){let t=e.editor;if(!t||typeof t!="object")return;let n=t;if(!(typeof n.getValue!="function"||typeof n.getCursor!="function"||typeof n.replaceRange!="function"||typeof n.setCursor!="function"))return n}contextFromMarkdownViewQuiet(e){let t=e.file;if(!(t instanceof p.TFile))return;let n=this.editorForMarkdownViewQuiet(e);if(!n)return;let r=n.getValue(),s=n.getCursor(),c=n.getCursor("from"),a=n.getCursor("to");return{view:e,file:t,editor:n,key:t.path,text:r,cursorOffset:I(r,s),cursorLine:s.line,selectionStart:I(r,c),selectionEnd:I(r,a)}}activeContextQuiet(){let e=this.app.workspace.getActiveViewOfType(p.MarkdownView);if(e)return this.contextFromMarkdownViewQuiet(e)}anyMarkdownContextQuiet(){let e=this.preferredMarkdownLeaf();if(e?.view instanceof p.MarkdownView){let t=this.contextFromMarkdownViewQuiet(e.view);if(t)return t}for(let t of this.markdownViews()){let n=this.contextFromMarkdownViewQuiet(t);if(n)return n}}async waitForEditorContextReady(e,t=550){let n=e.view instanceof p.MarkdownView&&e.view.file instanceof p.TFile?e.view.file.path:"",r=Date.now();for(;Date.now()-r<=t;){let s=this.activeContextQuiet();if(s){this.logStatus("command.context.ready",{file:s.file.path,elapsedMs:Date.now()-r,targetFile:n,active:!0});return}let c=this.anyMarkdownContextQuiet();if(c){this.logStatus("command.context.ready",{file:c.file.path,elapsedMs:Date.now()-r,targetFile:n,active:!1});return}if(e.isDeferred)try{await e.loadIfDeferred()}catch{}await new Promise(a=>{window.setTimeout(a,25)})}this.logStatus("command.context.wait.timeout",{timeoutMs:t,targetFile:n})}getStatusLogPath(){return this.statusLogPath}readStatusLogContents(){if(!(!this.statusLogPath||!x.existsSync(this.statusLogPath)))try{return x.readFileSync(this.statusLogPath,"utf8")}catch(e){this.logStatus("status-log.read.failed",{error:P(e)});return}}clearStatusLog(){if(this.statusLogPath)try{x.writeFileSync(this.statusLogPath,"",{encoding:"utf8"}),this.logStatus("status-log.cleared"),this.updateStatus("Status log cleared.")}catch(e){this.showError(`Failed to clear status log: ${e.message}`)}}showStatusLog(){new Pe(this.app,this).open()}async copyStatusLogPath(){let e=this.statusLogPath;if(!e){this.updateStatus("Status log path is unavailable.");return}try{await navigator.clipboard.writeText(e),this.updateStatus("Status log path copied to clipboard.")}catch{this.updateStatus(`Status log path: ${e}`)}}describeLeafType(e){return e?e.view?.getViewType?.()??"<unknown>":"<none>"}markdownModeForView(e){if(!e)return"unknown";try{let t=e.getMode?.();if(t==="source"||t==="preview")return t}catch{}return"unknown"}describeLeafMode(e){return!e||!(e.view instanceof p.MarkdownView)?"unknown":this.markdownModeForView(e.view)}describeLeafFile(e){return e?e.view.file?.path??"":""}safeRun(e,t){try{t()}catch(n){this.logStatus(`${e}.error`,{error:P(n)}),this.showError(`Unexpected plugin error (${e}): ${n.message}`)}}initializeStatusLog(){let e=this.pluginDirectoryPath();if(e)try{if(x.mkdirSync(e,{recursive:!0}),this.statusLogPath=E.join(e,Pt),x.existsSync(this.statusLogPath)&&x.statSync(this.statusLogPath).size>Rt){let n=`${this.statusLogPath}.1`;try{x.unlinkSync(n)}catch{}x.renameSync(this.statusLogPath,n)}this.logStatus("status-log.initialized",{path:this.statusLogPath}),this.trimStatusLogToMaxLines()}catch{this.statusLogPath=void 0}}trimStatusLogToMaxLines(){if(!(!this.statusLogPath||!x.existsSync(this.statusLogPath)))try{let e=x.readFileSync(this.statusLogPath,"utf8");if(!e)return;let t=e.split(/\r?\n/);if(t.length<=je)return;let n=t.slice(-je).join(`
`),r=n.endsWith(`
`)?n:`${n}
`;x.writeFileSync(this.statusLogPath,r,{encoding:"utf8"})}catch{}}logStatus(e,t){let n=this.composeLogLine(e,t);if(console.log(n),!(!this.settings.diagnosticLogging||!this.statusLogPath))try{x.appendFileSync(this.statusLogPath,`${n}
`,{encoding:"utf8"}),this.statusLogWriteCount+=1,this.statusLogWriteCount>=64&&(this.statusLogWriteCount=0,this.trimStatusLogToMaxLines())}catch{}}logDecorationSummary(e,t){if(!this.settings.diagnosticLogging)return;let n=JSON.stringify(t);this.lastDecorationSummaryByDoc.get(e)!==n&&(this.lastDecorationSummaryByDoc.set(e,n),this.logStatus("cm.decorations.summary",{file:e,...t}))}composeLogLine(e,t){let n={ts:new Date().toISOString(),session:this.logSessionId,event:e};return t&&Object.keys(t).length>0&&(n.payload=t),`[binoculars] ${JSON.stringify(n)}`}async onunload(){this.logStatus("plugin.onunload.begin");for(let e of this.liveEstimateTimers.keys())this.clearLiveEstimateTimer(e);await this.stopBackend({shutdownDaemon:!0}),this.app.workspace.getLeavesOfType(W).forEach(e=>{this.app.workspace.detachLeavesOfType(W),e.detach()}),this.logStatus("plugin.onunload.end")}isExtensionEnabled(){return this.settings.enabled}getLastStatusMessage(){return this.lastStatusMessage}getControlsStatusMessage(){return this.isControlsBlockedByInFlightAnalysis()?Lt:this.lastStatusMessage}isForegroundBusy(){return this.foregroundBusyOperationCount>0}preferredControlsDocKey(){return(this.activeContextQuiet()??this.anyMarkdownContextQuiet())?.key}isControlsBusyBlocked(){if(this.foregroundBusyOperationCount<=0)return!1;let e=this.foregroundBusyDocKey;if(!e)return!1;let t=this.preferredControlsDocKey();return t?t!==e:!0}isControlsBlockedByInFlightAnalysis(){return this.isControlsBusyBlocked()&&this.foregroundBusyKind==="analysis"}refreshControlsAfterBusyCheck(){if(!this.isExtensionEnabled()){this.refreshControlsView();return}if(this.isControlsBlockedByInFlightAnalysis()){this.refreshControlsView();return}this.updateStatusForActiveEditor(),this.refreshControlsView()}postStatus(e){this.updateStatus(e)}getSettings(){return this.settings}resetVisualsDisabledHint(){this.visualsDisabledHintShown=!1}isRuntimeColorizationEnabled(){return this.runtimeColorizationEnabled}currentRibbonToggleTooltip(){return this.isExtensionEnabled()?"Disable Binoculars":"Enable Binoculars"}refreshRibbonToggleTooltip(){let e=this.currentRibbonToggleTooltip();this.ribbonToggleEl?.setAttr("title",e),this.ribbonToggleEl?.setAttr("aria-label",e)}getUiIconId(){return this.uiIconId}async togglePluginEnablementFromRibbon(){this.isExtensionEnabled()?await this.disableExtension():await this.enableExtension({openControlsIfMissing:!0,focusControls:!0})}registerCustomIcons(){try{(0,p.addIcon)(ce,Mt),this.uiIconId=ce,this.logStatus("icon.registered",{iconId:ce})}catch(e){this.uiIconId="telescope",this.logStatus("icon.register.failed",{iconId:ce,fallbackIconId:this.uiIconId,error:P(e)})}}activeChunkCount(){let e=this.activeContext()??this.anyMarkdownContext();return e?this.docStates.get(e.key)?.chunks.length??0:0}hasAnyAnalysisForPreferredNote(){let e=this.activeContext()??this.anyMarkdownContext();if(!e)return!1;let t=this.docStates.get(e.key);return!!(t&&t.chunks.length>0)}hasAnyPriorsForPreferredNote(){let e=this.activeContext()??this.anyMarkdownContext();if(!e)return!1;let t=this.docStates.get(e.key);return t?(t.priorLowRanges?.length??0)>0||(t.priorHighRanges?.length??0)>0:!1}hasNextChunkAvailable(){let e=this.activeContext()??this.anyMarkdownContext();if(!e||!this.isExtensionEnabled())return!1;let t=e.text.length;if(t<=0)return!1;let n=this.docStates.get(e.key);return!n||n.chunks.length===0?!1:Math.max(0,n.nextChunkStart)<t}async enableExtension(e){if(this.settings.enabled=!0,await this.savePluginSettings(),await this.applyEnablementMode(),e?.focusControls){await this.openControlsView();return}e?.openControlsIfMissing&&this.app.workspace.getLeavesOfType(W).length===0&&await this.openControlsView()}async disableExtension(){this.settings.enabled=!1,await this.savePluginSettings(),await this.applyEnablementMode()}async applyEnablementMode(){if(this.logStatus("mode.apply.begin",{enabled:this.isExtensionEnabled()}),!this.isExtensionEnabled()){await this.stopBackend({shutdownDaemon:!0});for(let t of this.liveEstimateTimers.keys())this.clearLiveEstimateTimer(t);this.liveEstimateEpochs.clear(),this.liveEstimateRecoverAttempts.clear(),this.recentTypingActivity.clear(),this.hoverSeenSegments.clear(),this.docStates.clear(),this.loadedSidecarSignatures.clear(),ue&&this.statusBarEl.hide(),this.lastStatusMessage="Binoculars disabled.",this.refreshAllDecorations(),this.refreshControlsView(),this.refreshRibbonToggleTooltip(),this.logStatus("mode.apply.disabled");return}let e=this.activeContext();e&&this.isMarkdownSidecarEligible(e.file)&&this.maybeLoadStateSidecar(e.file,e.text,"activate"),ue&&this.statusBarEl.show(),e&&this.docStates.has(e.file.path)&&this.refreshDecorationsForFile(e.file.path),this.updateStatusForActiveEditor(),this.refreshControlsView(),this.refreshRibbonToggleTooltip(),this.logStatus("mode.apply.enabled")}async restartBackend(){if(!this.isExtensionEnabled()){await this.stopBackend({shutdownDaemon:!0});return}await this.stopBackend({shutdownDaemon:!0}),await this.ensureBackend(),this.updateStatus("Binoculars backend restarted.")}blockIfForegroundBusy(e){if(this.foregroundBusyOperationCount<=0)return!1;this.logStatus("command.busy",{action:e,busyCount:this.foregroundBusyOperationCount});let t=`Binoculars is busy with another request. Wait for completion, then retry ${e}.`;return this.updateStatus(t),!0}async runAnalyze(){if(!this.ensureEnabledOrNotify()||this.blockIfForegroundBusy("Analyze"))return;this.logStatus("command.analyze.begin");let e=this.preferredContextForCommand("Analyze");if(!e){this.logStatus("command.analyze.no-context");return}e=await this.ensureSourceModeForOverlays(e,"Analyze"),this.clearLiveEstimateTimer(e.key);let t=this.docStates.get(e.key),n=t&&t.chunks.length>0?this.getActiveChunk(e.text,e.cursorOffset,t):void 0,r=Math.max(0,Math.min(e.text.length,n?.charStart??0)),s=G(e.text,r);this.updateStatus(`Analyzing chunk from line ${s}...`);try{let c=await this.runWithBusyNotice(`Analyzing chunk from line ${s}...`,async()=>{let d=await this.ensureBackend();return t&&t.chunks.length>0?d.analyzeChunk(e.text,this.inputLabel(e.file),r,e.text.length):d.analyzeDocument(e.text,this.inputLabel(e.file))},{docKey:e.key,kind:"analysis"}),a=de(c),l=Math.max(1,Math.trunc(Number.isFinite(this.settings.topK)?this.settings.topK:5)),h=t?he(t,a,e.text.length,l):void 0,f;t&&t.chunks.length>0?(t.priorLowRanges=R([...t.priorLowRanges??[],...h?.low??[]]),t.priorHighRanges=R([...t.priorHighRanges??[],...h?.high??[]]),t.priorChunkB=ee(t,a),ke(t,a),t.nextChunkStart=we(t.chunks,e.text.length),t.stale=!1,t.forecastEstimate=void 0,t.forecastPending=!1,t.editedRanges=[],t.rewriteRanges=[],f=t):f={chunks:[a],nextChunkStart:c.next_chunk_start??c.chunk.analyzed_char_end,stale:!1,editedRanges:[],rewriteRanges:[],priorLowRanges:R([...t?.priorLowRanges??[],...h?.low??[]]),priorHighRanges:R([...t?.priorHighRanges??[],...h?.high??[]]),priorChunkB:ee(t,a),forecastEstimate:void 0,forecastPending:!1},this.docStates.set(e.key,f),this.docVersions.set(e.key,this.docVersionForKey(e.key)),this.refreshDecorationsForFile(e.key),this.autoSaveStateSidecar(e.file,e.text),this.updateStatusForActiveEditor(),this.refreshControlsView(),this.maybeNotifyVisualsDisabled(),this.maybeNotifyReadingViewOverlayHidden(e.key)}catch(c){this.handleOperationFailure("Analyze",c)}}async runAnalyzeNext(){if(!this.ensureEnabledOrNotify()||this.blockIfForegroundBusy("Analyze Next"))return;this.logStatus("command.analyze-next.begin");let e=this.preferredContextForCommand("Analyze Next");if(!e){this.logStatus("command.analyze-next.no-context");return}e=await this.ensureSourceModeForOverlays(e,"Analyze Next"),this.clearLiveEstimateTimer(e.key);let t=this.docStates.get(e.key);if(!t&&this.isMarkdownSidecarEligible(e.file)&&(this.maybeLoadStateSidecar(e.file,e.text,"activate"),t=this.docStates.get(e.key)),!t){await this.runAnalyze();return}let n=Math.max(0,t.nextChunkStart);if(n>=e.text.length){this.updateStatus("All text already covered by analyzed chunks.");return}let r=G(e.text,n);this.updateStatus(`Analyzing next chunk from line ${r}...`);try{let s=await this.runWithBusyNotice(`Analyzing next chunk from line ${r}...`,async()=>(await this.ensureBackend()).analyzeNextChunk(e.text,this.inputLabel(e.file),n),{docKey:e.key,kind:"analysis"}),c=de(s),a=Math.max(1,Math.trunc(Number.isFinite(this.settings.topK)?this.settings.topK:5)),l=he(t,c,e.text.length,a);t.priorLowRanges=R([...t.priorLowRanges??[],...l.low]),t.priorHighRanges=R([...t.priorHighRanges??[],...l.high]),t.priorChunkB=ee(t,c),ke(t,c),t.nextChunkStart=s.next_chunk_start??s.chunk.analyzed_char_end,t.stale=!1,t.forecastEstimate=void 0,t.forecastPending=!1,t.editedRanges=[],t.rewriteRanges=[],this.refreshDecorationsForFile(e.key),this.autoSaveStateSidecar(e.file,e.text),this.updateStatusForActiveEditor(),this.refreshControlsView(),this.maybeNotifyVisualsDisabled(),this.maybeNotifyReadingViewOverlayHidden(e.key)}catch(s){this.handleOperationFailure("Analyze Next",s)}}async runAnalyzeAll(){if(!this.ensureEnabledOrNotify()||this.blockIfForegroundBusy("Analyze All"))return;this.logStatus("command.analyze-all.begin");let e=this.preferredContextForCommand("Analyze All");if(!e){this.logStatus("command.analyze-all.no-context");return}e=await this.ensureSourceModeForOverlays(e,"Analyze All"),this.clearLiveEstimateTimer(e.key);let t=this.docStates.get(e.key),n=Math.max(0,t?.nextChunkStart??0);if(e.text.length<=0||n>=e.text.length){this.updateStatus("All text already covered by analyzed chunks.");return}if(!await new Ce(this.app,"Analyze All may take a while on long documents. Are you sure?").openAndWait()){this.updateStatus("Analyze All canceled.");return}let s=this.docVersionForKey(e.key);try{await this.runWithBusyNotice("Analyzing all remaining chunks...",async()=>{let a=await this.ensureBackend(),l=this.docStates.get(e.key),h=this.currentTextForKey(e.key)??e.text;if(!l||l.chunks.length===0){this.updateStatus("Analyze All in progress: analyzing initial chunk...");let d=await a.analyzeDocument(h,this.inputLabel(e.file)),g=de(d),u=Math.max(1,Math.trunc(Number.isFinite(this.settings.topK)?this.settings.topK:5)),m=l?he(l,g,h.length,u):void 0;l={chunks:[g],nextChunkStart:d.next_chunk_start??d.chunk.analyzed_char_end,stale:!1,editedRanges:[],rewriteRanges:[],priorLowRanges:R([...l?.priorLowRanges??[],...m?.low??[]]),priorHighRanges:R([...l?.priorHighRanges??[],...m?.high??[]]),priorChunkB:ee(l,g),forecastEstimate:void 0,forecastPending:!1},this.docStates.set(e.key,l),this.refreshDecorationsForFile(e.key)}let f=0;for(;l&&l.nextChunkStart<h.length;){if(f+=1,f>512)throw new Error("Analyze All aborted due to unexpected excessive chunk iterations.");if(this.docVersionForKey(e.key)!==s)throw new Error("Document changed while Analyze All was running. Re-run Analyze All on current text.");let d=Math.max(0,l.nextChunkStart),g=G(h,d);this.updateStatus(`Analyze All in progress: analyzing from line ${g}...`);let u=await a.analyzeNextChunk(h,this.inputLabel(e.file),d),m=de(u),b=Math.max(1,Math.trunc(Number.isFinite(this.settings.topK)?this.settings.topK:5)),y=he(l,m,h.length,b);l.priorLowRanges=R([...l.priorLowRanges??[],...y.low]),l.priorHighRanges=R([...l.priorHighRanges??[],...y.high]),l.priorChunkB=ee(l,m),ke(l,m);let v=d;if(l.nextChunkStart=u.next_chunk_start??u.chunk.analyzed_char_end,l.stale=!1,l.forecastEstimate=void 0,l.forecastPending=!1,l.editedRanges=[],l.rewriteRanges=[],this.refreshDecorationsForFile(e.key),l.nextChunkStart<=v)throw new Error("Analyze All made no forward progress. Try Analyze Chunk again.")}},{docKey:e.key,kind:"analysis"});let c=this.currentTextForKey(e.key)??e.text;this.autoSaveStateSidecar(e.file,c),this.updateStatusForActiveEditor(),this.refreshControlsView(),this.maybeNotifyVisualsDisabled(),this.maybeNotifyReadingViewOverlayHidden(e.key)}catch(c){this.handleOperationFailure("Analyze All",c)}}async runRewriteSelection(){if(!this.ensureEnabledOrNotify()||this.blockIfForegroundBusy("Rewrite"))return;this.updateStatus("Preparing rewrite request..."),this.logStatus("command.rewrite-selection.begin");let e=this.preferredContextForCommand("Rewrite Selection");if(!e){this.logStatus("command.rewrite-selection.no-context");return}let t=this.docStates.get(e.key);if(!t&&this.isMarkdownSidecarEligible(e.file)&&(this.maybeLoadStateSidecar(e.file,e.text,"activate"),t=this.docStates.get(e.key)),!t||t.chunks.length===0){this.showError("Run Analyze first before requesting rewrite suggestions.");return}let n=this.resolveRewriteSpan(e.text,e.selectionStart,e.selectionEnd,e.cursorOffset,t);if(!n){this.showError("No scored span available for rewrite at cursor/selection.");return}await this.runRewriteForSpan(e.key,e.file,e.text,n.start,n.end,t)}async runRewriteSelectionOrLine(){if(!this.ensureEnabledOrNotify()||this.blockIfForegroundBusy("Rewrite"))return;this.updateStatus("Preparing rewrite request..."),this.logStatus("command.rewrite-selection-or-line.begin");let e=this.preferredContextForCommand("Rewrite Selection");if(!e){this.logStatus("command.rewrite-selection-or-line.no-context");return}let t=this.docStates.get(e.key);if(!t&&this.isMarkdownSidecarEligible(e.file)&&(this.maybeLoadStateSidecar(e.file,e.text,"activate"),t=this.docStates.get(e.key)),!t||t.chunks.length===0){this.showError("Run Analyze first before requesting rewrite suggestions.");return}let n=this.resolveSelectionOrLineSpan(e.text,e.selectionStart,e.selectionEnd,e.cursorLine);if(!n){this.showError("No line or selection is available for rewrite at cursor position.");return}await this.runRewriteForSpan(e.key,e.file,e.text,n.start,n.end,t)}async runRewriteForSpan(e,t,n,r,s,c){let a=this.activeContext()?.cursorOffset??r,h=this.getActiveChunk(n,a,c)?.metrics,f=this.docVersionForKey(e);try{let d=await this.runWithBusyNotice("Generating rewrite options...",async()=>(await this.ensureBackend()).rewriteSpan(n,r,s,h?{binoculars_score:h.binoculars_score,observer_logPPL:h.observer_logPPL,cross_logXPPL:h.cross_logXPPL,transitions:h.transitions}:void 0,3),{docKey:e,kind:"rewrite"}),g=(d.rewrites||[]).slice(0,3);if(g.length===0){this.showError("No rewrite options returned.");return}this.updateStatus("Reviewing rewrite options...");let u=await new Me(this.app,d.source,g).openAndWait();if(!u||!u.text||!u.text.trim()){this.updateStatus("Rewrite selection canceled.");return}if(this.docVersionForKey(e)!==f){this.showError("Document changed while rewrite options were open. Re-run rewrite for current text.");return}let m=this.activeContext();if(!m||m.key!==e){this.showError("Active editor changed before rewrite could be applied.");return}let b=ge(n,r),y=ge(n,s);m.editor.replaceRange(u.text,b,y);let v=this.docStates.get(e);if(v){v.stale=!0,v.priorChunkB=void 0,v.editedRanges=R([...v.editedRanges,{start:r,end:r+u.text.length}]),v.rewriteRanges=R([...v.rewriteRanges,{start:r,end:r+u.text.length}]);let F=Number(u.approx_B??Number.NaN),C=this.currentTextForKey(e)??m.editor.getValue(),L=Math.max(0,Math.min(C.length,r+u.text.length)),w=this.getActiveChunk(C,L,v);w&&Number.isFinite(F)&&(v.forecastEstimate={chunkStart:w.charStart,docVersion:this.docVersionForKey(e),b:F}),v.forecastPending=!0}let M=m.editor.getValue();m.editor.setCursor(ge(M,r+u.text.length)),this.refreshDecorationsForFile(e),this.scheduleLiveEstimate(e),this.updateStatusForActiveEditor(),this.updateStatus("Rewrite applied. Analyze to confirm exact B."),this.autoSaveStateSidecar(t,M)}catch(d){this.handleOperationFailure("Rewrite",d)}}clearPriors(){if(!this.ensureEnabledOrNotify())return;let e=this.preferredContextForCommand("Clear Priors");if(!e)return;let t=this.docStates.get(e.key);t&&(t.priorLowRanges=[],t.priorHighRanges=[],this.refreshDecorationsForFile(e.key),this.updateStatus("Cleared prior highlights."))}toggleColorization(){if(!this.ensureEnabledOrNotify()||this.blockIfForegroundBusy("Toggle Colorization"))return;this.runtimeColorizationEnabled=!this.runtimeColorizationEnabled,this.refreshAllDecorations(),this.updateStatusForActiveEditor(),this.refreshControlsView();let e=this.visualizationStatusSuffix();this.updateStatus(`Colorization ${this.runtimeColorizationEnabled?"ON":"OFF"}${e}.`)}async ensureBackend(){if(!this.isExtensionEnabled())throw new Error('Binoculars is disabled. Run "Binoculars: Enable" to re-enable.');this.backend||(this.backend=new Z(f=>{this.logStatus("bridge.message",{line:f})}));let e=this.resolvePathSetting(this.settings.backendPythonPath),t=this.resolvePathSetting(this.settings.backendBridgeScriptPath),n=this.resolvePathSetting(this.settings.configPath),r=Math.max(1,Math.trunc(Number.isFinite(this.settings.topK)?this.settings.topK:5)),s=this.settings.textMaxTokensOverride===null||typeof this.settings.textMaxTokensOverride>"u"?null:Math.max(0,Math.trunc(this.settings.textMaxTokensOverride)),c=this.resolvePathSetting(this.settings.observerGgufPath),a=this.resolvePathSetting(this.settings.performerGgufPath),l=this.resolveRewriteLlmConfigPath(),h=this.vaultBasePath();return this.logStatus("backend.ensure.start",{pythonPath:e,bridgeScriptPath:t,configPath:n,topK:r,textMaxTokensOverride:s,observerModelPath:c,performerModelPath:a,rewriteLlmConfigPath:l,cwd:h??""}),await this.backend.start(e,t,h),this.backendStarted=!0,await this.backend.initialize(n,r,s,c,a,l),this.logStatus("backend.ensure.ready"),this.backend}async stopBackend(e){let t=e?.shutdownDaemon===!0;if(this.logStatus("backend.stop.begin",{shutdownDaemon:t,hadBackend:!!this.backend}),t)try{if(this.backend)await this.backend.shutdownDaemon();else{let n=new Z(()=>{});await n.shutdownDaemon(),n.dispose()}}catch{}try{await this.backend?.shutdown()}catch{}this.backend=void 0,this.backendStarted=!1,this.logStatus("backend.stop.end")}resolveRewriteLlmConfigPath(){let e=this.settings.externalLlmEnabled,t=this.resolvePathSetting(this.settings.externalLlmConfigPath),n=String(this.settings.externalLlmEndpoint??"").trim(),r=String(this.settings.externalLlmModel??"").trim(),s=Number(this.settings.externalLlmTemperature),c=Math.max(1,Math.trunc(Number(this.settings.externalLlmMaxTokens))),a=n.length>0||r.length>0;if(e&&!a)return t;let l=this.pluginDirectoryPath();if(!l)return t;try{x.mkdirSync(l,{recursive:!0})}catch{return t}let h=E.join(l,"rewrite-llm.runtime.json"),f={};if(t&&x.existsSync(t))try{let g=x.readFileSync(t,"utf8"),u=JSON.parse(g);u&&typeof u=="object"&&(f=u)}catch{f={}}let d=f.llm&&typeof f.llm=="object"?{...f.llm}:{};d.enabled=e,n&&(d.endpoint_url=n),r&&(d.model=r),d.temperature=s,d.max_tokens=c,f.llm=d;try{return x.writeFileSync(h,JSON.stringify(f,null,2),{encoding:"utf8"}),h}catch{return t}}async openControlsView(){let e=this.app.workspace.getLeavesOfType(W);if(e.length>0){await this.app.workspace.revealLeaf(e[0]),this.controlsView?.render();return}let t=this.app.workspace.getRightLeaf(!1);t&&(await t.setViewState({type:W,active:!0}),await this.app.workspace.revealLeaf(t),this.controlsView?.render())}refreshControlsView(){this.controlsView?.render()}updateStatus(e){if(this.lastStatusMessage=e,!this.isExtensionEnabled()){this.refreshControlsView();return}if(ue){let t=e.startsWith("Binoculars ")?e:`Binoculars: ${e}`;this.statusBarEl.setText(t)}this.refreshControlsView()}visualizationStatusSuffix(){if(!this.settings.editorIntegrationEnabled)return" | overlays disabled (enable Editor integration + reload)";let e=this.app.workspace.getActiveViewOfType(p.MarkdownView);return this.markdownModeForView(e)==="preview"?" | overlays hidden in Reading view":""}maybeNotifyVisualsDisabled(){this.settings.editorIntegrationEnabled||this.visualsDisabledHintShown||(this.visualsDisabledHintShown=!0,this.logStatus("editor-integration.visuals-disabled-hint"),this.updateStatus("Analyze completed. Visual overlays are disabled. Enable Editor integration and reload plugin to see colorization/gutter bars."))}looksLikeVramOomError(e){let t=(()=>{if(e instanceof O){let r=e.details&&typeof e.details=="object"?JSON.stringify(e.details):"";return`${e.message} ${r}`}return e instanceof Error?e.message:String(e??"")})().toLowerCase().trim();return t?["oom_vram","out of memory","cuda out of memory","cuda error out of memory","failed to allocate","allocation failed","cublas_status_alloc_failed","cudamalloc","ggml_backend_cuda","hiperroroutofmemory","not enough memory","insufficient memory","vram","std::bad_alloc"].some(r=>t.includes(r)):!1}looksLikeBridgeTimeout(e){let t=(e instanceof Error?e.message:String(e??"")).toLowerCase().trim();return t?t.includes("bridge request timed out")||t.includes("timed out waiting for daemon ready event"):!1}formatOperationErrorMessage(e,t){if((t instanceof O?t.code:"")==="oom_vram"||this.looksLikeVramOomError(t))return`${e} failed: GPU VRAM appears exhausted. Try a smaller chunk, lower text.max_tokens override, and close other GPU-heavy apps (Obsidian/VS Code/other model sessions) before retrying.`;if(this.looksLikeBridgeTimeout(t))return`${e} failed: request timed out while waiting on the shared Binoculars daemon. It may be busy with another long-running analysis (Obsidian or VS Code). Wait, then retry, or use Restart Backend if it appears stuck.`;let r=t instanceof Error?t.message:String(t??"unknown error");return`${e} failed: ${r}`}handleOperationFailure(e,t){this.logStatus("operation.failed",{action:e,error:P(t),bridgeCode:t instanceof O?t.code:"",bridgeMethod:t instanceof O?t.method:""}),this.showError(this.formatOperationErrorMessage(e,t))}showError(e){this.logStatus("ui.error",{message:e}),this.updateStatus(e)}isCmRuntimeReady(){return!!(pe&&B&&H&&Ue&&Xe&&Qe&&At&&Bt&&Je&&Ye&&Ze&&et)}updateStatusForActiveEditor(){if(!this.isExtensionEnabled()||this.foregroundBusyOperationCount>0)return;let e=this.visualizationStatusSuffix(),t=this.app.workspace.getActiveViewOfType(p.MarkdownView),n=t?this.contextFromMarkdownView(t,"active"):this.anyMarkdownContext();if(!n){this.updateStatus("Binoculars Ready. Select Analyze Chunk to begin.");return}let r=this.docStates.get(n.key);if(!r||r.chunks.length===0){this.updateStatus("Binoculars Ready. Select Analyze Chunk to begin.");return}let s=n.text,c=[...r.chunks].sort((w,A)=>w.charStart-A.charStart),a=n.cursorOffset,l=we(c,s.length),h=l<s.length,f=Fe(c.map(w=>({start:Math.max(0,Math.min(s.length,w.charStart)),end:Math.max(0,Math.min(s.length,w.analyzedCharEnd))})).filter(w=>w.end>w.start)),d=f.some(w=>a>=w.start&&a<w.end),g=d?c.find(w=>a>=w.charStart&&a<w.analyzedCharEnd):void 0;if(!d||!g){let w=rt(f,s.length),A=w.find(T=>a>=T.start&&a<T.end)??(a>=s.length?w[w.length-1]:void 0)??w.find(T=>T.start>a)??w[0],X=G(s,A?.start??a);h?this.updateStatus(`Text starting from line ${X} has not been analyzed. Select Analyze Next Chunk to continue.${e}`):this.updateStatus(`Text starting from line ${X} has not been analyzed. Select Analyze Chunk to refresh coverage.${e}`);return}if(!g.metrics){this.updateStatus(`Binoculars analyzed chunk available.${e}`);return}let u=Number(g.metrics.binoculars_score),m=r.stale?" | stale (run Analyze; estimate may differ from exact)":"",b=(()=>{let w=r.forecastEstimate;return!!w&&w.chunkStart===g.charStart&&w.docVersion===this.docVersionForKey(n.key)&&Number.isFinite(w.b)?{text:r.forecastPending?`${q(w.b)} (updating...)`:`${q(w.b)}`,value:Number(w.b)}:{text:"",value:void 0}})(),y=typeof b.value=="number"&&Number.isFinite(b.value)&&Number.isFinite(u)?b.value-u:void 0,v=typeof y=="number"&&Number.isFinite(y)?y!==0:!1,M=v?` | B Est.: ${b.text} | B Diff. Est.: ${q(y??0)}`:r.stale&&r.forecastPending?" | B Est.: estimating... | B Diff. Est.: estimating...":r.stale?" | B Est.: n/a | B Diff. Est.: n/a":"",F=typeof r.priorChunkB=="number"&&Number.isFinite(r.priorChunkB)?` | Prior B ${q(r.priorChunkB)}`:"",C=h?` | Analyze Next available (line ${G(s,l)})`:"",L=`B: ${q(u)}${F}${M} | Obs: ${J(g.metrics.observer_logPPL)} | Cross: ${J(g.metrics.cross_logXPPL)}${m}${C}${e}`;if(c.length>1){let w=Math.max(1,c.indexOf(g)+1);this.updateStatus(`Binoculars (chunk ${w}): ${L}`);return}this.updateStatus(L)}ensureEnabledOrNotify(){return this.isExtensionEnabled()?!0:(this.updateStatus('Binoculars is disabled. Run "Binoculars: Enable" to re-enable.'),!1)}resolvePathSetting(e){let t=this.vaultBasePath();return e?e.includes("${workspaceFolder}")&&t?e.split("${workspaceFolder}").join(t):e.includes("${vaultRoot}")&&t?e.split("${vaultRoot}").join(t):E.isAbsolute(e)?e:t?E.join(t,e):e:""}inputLabel(e){return this.absolutePathForFile(e)??e.path}vaultBasePath(){let e=this.app.vault.adapter;if(e instanceof p.FileSystemAdapter)return e.getBasePath();let t=e;if(typeof t.getBasePath=="function")return t.getBasePath()}pluginDirectoryPath(){let e=this.vaultBasePath();if(e)return E.join(e,".obsidian","plugins",this.manifest.id)}absolutePathForFile(e){let t=this.vaultBasePath();if(t)return E.join(t,e.path)}sidecarStatePathForFile(e,t=le,n=!0){let r=this.absolutePathForFile(e);if(!r)return;let s=E.parse(E.resolve(r)),c=n?`.${s.name}`:s.name;return E.join(s.dir,`${c}${t}`)}sidecarStateCandidatePathsForFile(e){let t=[this.sidecarStatePathForFile(e,le,!0),this.sidecarStatePathForFile(e,le,!1),this.sidecarStatePathForFile(e,_t,!1)].filter(s=>!!s);if(t.length===0)return[];let n=[],r=new Set;for(let s of t){let c=process.platform==="win32"?E.resolve(s).toLowerCase():E.resolve(s);r.has(c)||(r.add(c),n.push(s))}return n}vaultRelativePathForAbsolutePath(e){let t=this.vaultBasePath();if(!t)return;let n=E.resolve(t),r=E.resolve(e),s=E.relative(n,r);if(!(!s||s==="."||s.startsWith("..")||E.isAbsolute(s)))return s.split(E.sep).join("/")}sidecarFilesForMarkdownFile(e){let t=[],n=new Set;for(let r of this.sidecarStateCandidatePathsForFile(e)){let s=this.vaultRelativePathForAbsolutePath(r);if(!s)continue;let c=this.app.vault.getAbstractFileByPath(s);c instanceof p.TFile&&(n.has(c.path)||(n.add(c.path),t.push(c)))}return t}clearDocumentRuntimeState(e){this.clearLiveEstimateTimer(e),this.docStates.delete(e),this.loadedSidecarSignatures.delete(e),this.docVersions.delete(e),this.liveEstimateEpochs.delete(e),this.liveEstimateRecoverAttempts.delete(e),this.recentTypingActivity.delete(e),this.hoverSeenSegments.delete(e),this.lastDecorationSummaryByDoc.delete(e)}async handleVaultDelete(e){try{let t=e?.path??"<unknown>",n=e instanceof p.TFile?this.isMarkdownSidecarEligible(e):!1;if(this.logStatus("event.vault-delete",{file:t,isMarkdown:n}),!(e instanceof p.TFile)||(this.clearDocumentRuntimeState(e.path),this.refreshDecorationsForFile(e.path),this.updateStatusForActiveEditor(),this.refreshControlsView(),!n))return;let r=this.sidecarFilesForMarkdownFile(e);if(r.length===0){this.logStatus("sidecar.delete.none",{file:e.path});return}for(let s of r)try{await this.app.fileManager.trashFile(s),this.logStatus("sidecar.delete.trashed",{file:e.path,sidecar:s.path})}catch(c){this.logStatus("sidecar.delete.failed",{file:e.path,sidecar:s.path,error:P(c)})}}catch(t){this.logStatus("event.vault-delete.error",{error:P(t)})}}isMarkdownSidecarEligible(e){return E.extname(e.path).toLowerCase()===".md"}maybeLoadStateSidecar(e,t,n){if(!this.isMarkdownSidecarEligible(e))return;let r=e.path,s=te(t),c=this.sidecarStateCandidatePathsForFile(e),a=c[0];for(let b of c)if(x.existsSync(b)){a=b;break}if(!a||!x.existsSync(a))return;let l;try{l=x.readFileSync(a,"utf8")}catch{this.logStatus("sidecar.read.failed",{reason:n,sidecarPath:a,file:r});return}let h=`${s}:${te(l)}`;if(this.loadedSidecarSignatures.get(r)===h)return;let f;try{f=JSON.parse(l)}catch{this.logStatus("sidecar.parse.failed",{reason:n,sidecarPath:a,file:r}),this.loadedSidecarSignatures.set(r,h);return}let d=Y(f);if(!d||d.binoculars_gui_state!==!0){this.logStatus("sidecar.ignored.unrecognized",{reason:n,sidecarPath:a,file:r}),this.loadedSidecarSignatures.set(r,h);return}let g=String(d.text_sha256??"").trim();if(g&&g!==s){this.logStatus("sidecar.ignored.hash-mismatch",{reason:n,sidecarPath:a,file:r}),this.loadedSidecarSignatures.set(r,h);return}let u=Y(d.state);if(!u){this.logStatus("sidecar.ignored.missing-state",{reason:n,sidecarPath:a,file:r}),this.loadedSidecarSignatures.set(r,h);return}let m=Dt(u,t.length);if(this.loadedSidecarSignatures.set(r,h),!m){this.logStatus("sidecar.ignored.invalid-state",{reason:n,sidecarPath:a,file:r});return}this.docStates.set(r,m),this.refreshDecorationsForFile(r),this.updateStatusForActiveEditor(),this.refreshControlsView(),this.logStatus("sidecar.loaded",{reason:n,sidecarPath:a,file:r})}autoSaveStateSidecar(e,t){if(!this.isMarkdownSidecarEligible(e))return;let n=e.path,r=this.docStates.get(n),s=this.sidecarStatePathForFile(e,le),c=this.absolutePathForFile(e);if(!s||!c)return;let a=Ot(c,t,r),l=JSON.stringify(a,null,2);try{x.writeFileSync(s,l,{encoding:"utf8"}),this.loadedSidecarSignatures.set(n,`${te(t)}:${te(l)}`)}catch(h){let f=`State sidecar save failed: ${h.message}`;this.logStatus("sidecar.save.failed",{message:f,sidecarPath:s,file:n}),this.updateStatus(f)}}buildEditorExtension(){if(!this.isCmRuntimeReady())return this.logStatus("editor-integration.build.skipped",{loadError:Se}),[];let e=B,t=H,n=Ue,r=this,s=e.ViewPlugin.fromClass(class{constructor(d){this.view=d;try{this.decorations=r.buildDecorationsForView(this.view)}catch(g){r.logStatus("cm.decorations.constructor.error",{error:P(g)}),this.decorations=e.Decoration.none}}update(d){try{r.handleEditorViewUpdate(this.view,d);let g=d.transactions.some(u=>u.effects.some(m=>m.is(t)));(d.docChanged||d.selectionSet||d.viewportChanged||g)&&(this.decorations=r.buildDecorationsForView(this.view))}catch(g){r.logStatus("cm.decorations.update.error",{error:P(g)}),this.decorations=e.Decoration.none}}},{decorations:d=>d.decorations});class c extends e.GutterMarker{constructor(u,m){super();this.sign=u;this.widthPx=m}eq(u){return this.sign===u.sign&&this.widthPx===u.widthPx}toDOM(){let u=document.createElement("span");u.className="binoculars-gutter-bar";let m=Math.max(2,Math.round(Number.isFinite(this.widthPx)?this.widthPx:2)),b=this.sign==="red"?"#ff4d4f":"#2fbf71";return u.style.setProperty("--binoculars-bar-width",`${m}px`),u.style.setProperty("--binoculars-bar-color",b),u.style.setProperty("display","inline-block","important"),u.style.setProperty("height","16px","important"),u.style.marginTop="1px",u.style.borderRadius="1px",u.style.setProperty("width",`${Math.max(4,m)}px`,"important"),u.style.setProperty("background-color",b,"important"),u.style.verticalAlign="top",u}}class a extends e.GutterMarker{constructor(u){super();this.lineNo=u}eq(u){return this.lineNo===u.lineNo}toDOM(){let u=document.createElement("span");return u.className="binoculars-line-number",u.textContent=String(this.lineNo),u}}let l=e.gutter({class:"binoculars-line-number-gutter",lineMarker(d,g){try{if(!r.shouldRenderForcedLineNumbers(d))return null;let u=d.state.doc.lineAt(g.from).number;return new a(u)}catch(u){return r.logStatus("cm.line-numbers.lineMarker.error",{error:P(u)}),null}},initialSpacer(d){try{let g=Math.max(1,d.state.doc.lines);return new a(g)}catch(g){return r.logStatus("cm.line-numbers.initialSpacer.error",{error:P(g)}),new a(1)}}}),h=e.gutter({class:"binoculars-contribution-gutter",lineMarker(d,g){try{if(!r.isExtensionEnabled()||!r.settings.renderContributionBars)return null;let u=r.renderArtifactsByView.get(d);if(!u)return null;let m=d.state.doc.lineAt(g.from).number-1,b=u.lineContribution.get(m);if(!b)return null;let y=u.maxLineContributionMag>0?Math.min(ye-1,Math.round(b.mag/u.maxLineContributionMag*(ye-1))):0,v=Math.max(2,Math.round((y+1)/ye*18)),M=Math.max(4,v);return new c(b.sign,M)}catch(u){return r.logStatus("cm.gutter.lineMarker.error",{error:P(u)}),null}}}),f=e.hoverTooltip((d,g)=>{try{if(!r.isExtensionEnabled()||!Ct)return null;let u=r.docKeyForEditorView(d);if(!u||r.shouldSuppressHoverDuringTyping(u,g))return null;let m=r.hoverSeenSegments.get(u);if(m)if(g>=m.start&&g<m.end){if(Date.now()-m.lastSeenMs<=Et)return null}else r.hoverSeenSegments.delete(u);let b=d.state.doc.toString(),y=r.docStates.get(u);if(!y||y.chunks.length===0)return null;let v=r.hoverForOffset(u,b,g,y);return v?(v.segmentEnd>v.segmentStart&&r.hoverSeenSegments.set(u,{start:v.segmentStart,end:v.segmentEnd,lastSeenMs:Date.now()}),{pos:v.rangeStart,end:v.rangeEnd,above:!1,create(){let M=document.createElement("div");return M.className=v.isMinorContributor?"binoculars-hover-tooltip binoculars-hover-minor":"binoculars-hover-tooltip",M.innerHTML=v.html,{dom:M}}}):null}catch(u){return r.logStatus("cm.hover.error",{error:P(u)}),null}},{hoverTime:xt});return[n,s,l,h,f]}shouldRenderForcedLineNumbers(e){if(!this.isExtensionEnabled())return!1;let t=this.markdownViewForEditorView(e);if(!t||this.markdownModeForView(t)!=="source")return!1;let n=this.docKeyForEditorView(e);if(!n)return!1;let r=this.docStates.get(n);if(!r||r.chunks.length===0)return!1;let s=this.activeContextQuiet()??this.anyMarkdownContextQuiet();return!(!s||s.key!==n||e.dom.querySelector(".cm-gutters .cm-lineNumbers"))}handleEditorViewUpdate(e,t){if(!this.isExtensionEnabled())return;let n=this.docKeyForEditorView(e);if(n){if(t.docChanged){let r=[];t.changes.iterChanges((c,a,l,h,f)=>{r.push({rangeOffset:c,rangeLength:a-c,text:f.toString()})}),r.length>0&&(this.noteTypingActivity(n,r,t.state.doc.length),this.hoverSeenSegments.delete(n));let s=this.docStates.get(n);s&&r.length>0&&(s.stale=!0,s.priorChunkB=void 0,s.forecastPending=s.chunks.length>0,qt(s,r,t.state.doc.length),s.editedRanges=Ht(s.editedRanges,r),s.rewriteRanges=jt(s.rewriteRanges,r),s.priorLowRanges=nt(s.priorLowRanges,r),s.priorHighRanges=nt(s.priorHighRanges,r)),this.docVersions.set(n,this.docVersionForKey(n)+1),this.scheduleLiveEstimate(n),this.refreshControlsView(),this.updateStatusForActiveEditor()}t.selectionSet&&(this.updateStatusForActiveEditor(),this.refreshControlsView())}}buildDecorationsForView(e){if(!this.isCmRuntimeReady())return[];let t=B,n=Xe,r=Qe,s=Je,c=Ye,a=Ze,l=et,h=this.markdownViewForEditorView(e),f=this.markdownModeForView(h),d=this.docKeyForEditorView(e);if(!d)return this.renderArtifactsByView.set(e,{lineContribution:new Map,maxLineContributionMag:0}),t.Decoration.none;let g=this.docStates.get(d),u=e.state.doc.toString();if(!this.isExtensionEnabled()||!g||g.chunks.length===0)return this.renderArtifactsByView.set(e,{lineContribution:new Map,maxLineContributionMag:0}),t.Decoration.none;let m=Math.max(1,Math.trunc(Number.isFinite(this.settings.topK)?this.settings.topK:5)),b=this.isTextOverlayColorizationEnabled(),y=[],v=[],M=[],F=[],C=[],L=new Map;for(let k of g.chunks)for(let _ of k.rows){let $=Math.max(0,Math.min(u.length,_.char_start)),j=Math.max($,Math.min(u.length,_.char_end));if(j<=$)continue;let Q=Number(_.delta_doc_logPPL_if_removed??0);C.push({range:{start:$,end:j},delta:Q});let re=G(u,$)-1,ie=G(u,Math.max($,j-1))-1,S=Math.abs(Q),D=Q>=0?"red":"green";for(let K=re;K<=ie;K+=1){let lt=I(u,{line:K,ch:0}),ut=Math.max($,Math.min(j-1,Math.min(u.length-1,lt))),Oe=L.get(K);(!Oe||S>Oe.mag)&&L.set(K,{sign:D,mag:S,anchorOffset:ut})}}let w=C.map((k,_)=>({idx:_,delta:k.delta})),A=new Set(w.filter(k=>Number.isFinite(k.delta)&&k.delta>=0).sort((k,_)=>_.delta-k.delta).slice(0,m).map(k=>k.idx)),X=new Set(w.filter(k=>Number.isFinite(k.delta)&&k.delta<0).sort((k,_)=>k.delta-_.delta).slice(0,m).map(k=>k.idx));for(let k=0;k<C.length;k+=1)A.has(k)?y.push(C[k].range):X.has(k)?v.push(C[k].range):C[k].delta>=0?M.push(C[k].range):F.push(C[k].range);let T=[],ne=0,Te=0,Ne=0,Ve=0,De=0;if(b){let k=[],_=(S,D,K)=>{S.end<=S.start||k.push({start:S.start,end:S.end,deco:D,priority:K})};for(let S of y)_(S,n,10);for(let S of v)_(S,r,11);let $=Fe(g.chunks.map(S=>({start:S.charStart,end:S.analyzedCharEnd})).filter(S=>S.end>S.start)),j=rt($,u.length);Te=j.length;for(let S of j)_(S,a,30);let Q=R(g.priorLowRanges);Ne=Q.length;for(let S of Q)_(S,s,40);let re=R(g.priorHighRanges);Ve=re.length;for(let S of re)_(S,c,41);let ie=R(g.editedRanges);De=ie.length;for(let S of ie)_(S,l,50);k.sort((S,D)=>S.start!==D.start?S.start-D.start:S.end!==D.end?S.end-D.end:S.priority-D.priority);for(let S of k)T.push(S.deco.range(S.start,S.end));ne=k.length}let ze=[...L.values()].map(k=>k.mag),ct=ze.length>0?Math.max(...ze):0;return this.renderArtifactsByView.set(e,{lineContribution:L,maxLineContributionMag:ct}),this.logDecorationSummary(d,{chunks:g.chunks.length,rows:C.length,lowMajor:y.length,highMajor:v.length,lowMinor:M.length,highMinor:F.length,unscored:Te,priorLow:Ne,priorHigh:Ve,edited:De,queued:ne,emitted:T.length,lineContribution:L.size,colorize:b,bars:!!this.settings.renderContributionBars,mode:f}),t.Decoration.set(T,!0)}hoverForOffset(e,t,n,r){let s=Math.max(0,t.lastIndexOf(`
`,Math.max(0,n-1))+1),c=t.indexOf(`
`,Math.max(0,n)),a=c>=0?c:t.length,l=Math.max(1,Math.trunc(Number.isFinite(this.settings.topK)?this.settings.topK:5)),h=Kt(r,n)??Gt(r,s,a),f=at(r,l),d=h?!f.has(h.row):!1,g=tt(r.rewriteRanges,n);if(g)return{html:"<strong>Segment rewritten</strong><br/>Select Analyze to determine new score.",isMinorContributor:d,segmentStart:g.start,segmentEnd:g.end,rangeStart:g.start,rangeEnd:g.end};let u=tt(r.editedRanges,n);if(!h)return u?{html:"<em>Note: some text has been manually changed which may impact score. Select Analyze again to obtain accurate statistics.</em>",isMinorContributor:!1,segmentStart:u.start,segmentEnd:u.end,rangeStart:u.start,rangeEnd:u.end}:void 0;let m=Number(h.row.delta_doc_logPPL_if_removed??Number.NaN),b=Math.max(0,Number(h.row.char_start??0)),y=Math.max(b,Number(h.row.char_end??b)),v=It(r.editedRanges,b,y),M=Number(h.chunk.metrics?.binoculars_score??Number.NaN),F=Number.isFinite(m)&&Number.isFinite(M)?M+m:Number.NaN,C=Number(h.row.logPPL??Number.NaN),w=[`<strong>Binoculars ${Number.isFinite(m)?m>=0?"LOW":"HIGH":"UNKNOWN"} Perplexity Segment</strong>`,`Delta if removed: <code>${xe(q(m))}</code> (Chunk changes to <code>${xe(q(F))}</code>)`,`Paragraph LogPPL: <code>${xe(J(C))}</code>`];(u||v)&&w.push("<em>Note: some text has been manually changed which may impact score. Select Analyze again to obtain accurate statistics.</em>");let A=w.join("<br/>"),X=s,T=a>s?a:y;return{html:A,isMinorContributor:d,segmentStart:b,segmentEnd:y,rangeStart:X,rangeEnd:T}}noteTypingActivity(e,t,n){if(t.length===0)return;let r=Number.MAX_SAFE_INTEGER,s=0;for(let c of t){let a=Math.max(0,Math.min(n,Number(c.rangeOffset??0))),l=Math.max(a,Math.min(n,a+String(c.text??"").length));r=Math.min(r,a),s=Math.max(s,l)}!Number.isFinite(r)||r===Number.MAX_SAFE_INTEGER||this.recentTypingActivity.set(e,{atMs:Date.now(),start:r,end:Math.max(r,s)})}shouldSuppressHoverDuringTyping(e,t){let n=this.recentTypingActivity.get(e);if(!n)return!1;if(Date.now()-n.atMs>kt)return this.recentTypingActivity.delete(e),!1;let s=120;return t>=Math.max(0,n.start-s)&&t<=n.end+s}scheduleLiveEstimate(e){if(!this.isExtensionEnabled()||this.foregroundBusyOperationCount>0)return;let t=this.docStates.get(e);if(!t||!t.stale||t.chunks.length===0)return;this.clearLiveEstimateTimer(e);let n=(this.liveEstimateEpochs.get(e)??0)+1;this.liveEstimateEpochs.set(e,n),t.forecastPending=!0,this.updateStatusForActiveEditor();let r=window.setTimeout(()=>{this.computeLiveEstimate(e,n)},St);this.liveEstimateTimers.set(e,r)}clearLiveEstimateTimer(e){let t=this.liveEstimateTimers.get(e);typeof t=="number"&&(window.clearTimeout(t),this.liveEstimateTimers.delete(e))}async computeLiveEstimate(e,t){if(!this.isExtensionEnabled()||this.foregroundBusyOperationCount>0||this.liveEstimateEpochs.get(e)!==t)return;this.clearLiveEstimateTimer(e);let n=this.activeContext(),r=this.docStates.get(e);if(!n||n.key!==e||!r||!r.stale||r.chunks.length===0)return;let s=n.text,c=n.cursorOffset,h=[...r.chunks].sort((m,b)=>m.charStart-b.charStart).find(m=>c>=m.charStart&&c<m.analyzedCharEnd)??this.getActiveChunk(s,c,r);if(!h||c<h.charStart||c>=h.analyzedCharEnd){r.forecastPending=!1,this.updateStatusForActiveEditor();return}let f=Math.max(0,h.charStart),d=Math.max(f,Math.min(s.length,h.analyzedCharEnd)),g=Number(h.metrics?.cross_logXPPL??Number.NaN);if(!Number.isFinite(g)||g===0){r.forecastPending=!1,r.forecastEstimate=void 0,this.updateStatusForActiveEditor();return}let u=this.docVersionForKey(e);try{let b=await(await this.ensureBackend()).estimateLiveB(s,this.inputLabel(n.file),f,d,g);if(this.liveEstimateEpochs.get(e)!==t)return;let y=this.docStates.get(e),v=this.activeContext();if(!y||!v||v.key!==e||this.docVersionForKey(e)!==u)return;let M=Number(b.approx_b??Number.NaN),F=Number(b.observer_logPPL??Number.NaN),C=Number.isFinite(M)?M:Number.isFinite(F)&&Number.isFinite(g)&&g!==0?F/g:Number.NaN;if(y.forecastPending=!1,Number.isFinite(C))y.forecastEstimate={chunkStart:f,docVersion:u,b:C},this.liveEstimateRecoverAttempts.delete(e);else{let L=this.liveEstimateRecoverAttempts.get(e)??0;if(this.logStatus("estimate.non-finite",{key:e,attempt:L,approx_b:b.approx_b,observer_logPPL:b.observer_logPPL,baseCross:g}),L<1){this.liveEstimateRecoverAttempts.set(e,L+1),await this.stopBackend({shutdownDaemon:!0}),this.scheduleLiveEstimate(e);return}}this.updateStatusForActiveEditor()}catch(m){if(this.liveEstimateEpochs.get(e)!==t)return;let b=this.docStates.get(e);b&&(b.forecastPending=!1);let y=this.liveEstimateRecoverAttempts.get(e)??0;if(y<1){this.liveEstimateRecoverAttempts.set(e,y+1);try{await this.stopBackend({shutdownDaemon:!0})}catch{}this.scheduleLiveEstimate(e);return}this.updateStatusForActiveEditor(),this.logStatus("estimate.failed",{key:e,error:P(m)})}}refreshAllDecorations(){if(!this.settings.editorIntegrationEnabled||!H)return;let e=H;for(let t of this.markdownViews()){let n=this.editorViewForMarkdownView(t);if(n)try{n.dispatch({effects:e.of(null)})}catch(r){this.logStatus("cm.refresh-all.dispatch.error",{file:t.file?.path??"",error:P(r)})}}}refreshDecorationsForFile(e){if(!this.settings.editorIntegrationEnabled||!H)return;let t=H;for(let n of this.markdownViews()){if(!n.file||n.file.path!==e)continue;let r=this.editorViewForMarkdownView(n);if(r)try{r.dispatch({effects:t.of(null)})}catch(s){this.logStatus("cm.refresh-file.dispatch.error",{file:e,error:P(s)})}}}markdownViews(){return this.app.workspace.getLeavesOfType("markdown").map(e=>e.view).filter(e=>e instanceof p.MarkdownView)}markdownLeavesWithFiles(){return this.app.workspace.getLeavesOfType("markdown").map(e=>{if(e.view instanceof p.MarkdownView&&e.view.file instanceof p.TFile)return{leaf:e,view:e.view}}).filter(e=>!!e)}preferredMarkdownLeaf(){let e=this.markdownLeavesWithFiles();if(e.length===0)return;let t=f=>{if(f)return e.find(d=>d.view.file?.path===f)?.leaf},n=this.app.workspace.getActiveViewOfType(p.MarkdownView);if(n?.file?.path){let f=t(n.file.path);if(f)return f}let r=this.app.workspace.getActiveFile()?.path,s=t(r);if(s)return s;let c=t(this.lastActiveMarkdownFilePath);if(c)return c;let a=t(this.lastOpenedMarkdownFilePath);if(a)return a;let l=this.app.workspace.getMostRecentLeaf();if(l?.view instanceof p.MarkdownView&&l.view.file instanceof p.TFile)return l;let h=e.find(f=>!!this.editorViewForMarkdownView(f.view));return h?h.leaf:e[0].leaf}editorViewForMarkdownView(e){return this.editorForMarkdownView(e)?.cm}markdownViewForEditorView(e){for(let t of this.markdownViews())if(this.editorViewForMarkdownView(t)===e)return t}docKeyForEditorView(e){let t=this.markdownViewForEditorView(e);if(t?.file)return t.file.path;let n=Date.now();n-this.lastUnmappedCmViewLogAtMs>1500&&(this.lastUnmappedCmViewLogAtMs=n,this.logStatus("cm.view.unmapped"))}currentTextForKey(e){for(let t of this.markdownViews())if(t.file?.path===e){let n=this.editorForMarkdownView(t);if(n)return n.getValue()}}docVersionForKey(e){return this.docVersions.get(e)??0}activeContext(){let e=this.app.workspace.getActiveViewOfType(p.MarkdownView);if(!e){this.logMissingContext("no-active-markdown-view");return}return this.contextFromMarkdownView(e,"active")}contextFromMarkdownView(e,t){let n=e.file;if(!n){this.logMissingContext("markdown-view-missing-file",{source:t});return}let r=this.editorForMarkdownView(e);if(!r){this.logMissingContext("markdown-view-missing-editor",{file:n.path,source:t});return}let s=r.getValue(),c=r.getCursor(),a=r.getCursor("from"),l=r.getCursor("to");return{view:e,file:n,editor:r,key:n.path,text:s,cursorOffset:I(s,c),cursorLine:c.line,selectionStart:I(s,a),selectionEnd:I(s,l)}}anyMarkdownContext(){let e=this.preferredMarkdownLeaf();if(e?.view instanceof p.MarkdownView){let t=this.contextFromMarkdownView(e.view,"fallback");if(t)return t}for(let t of this.markdownViews()){let n=this.contextFromMarkdownView(t,"fallback");if(n)return n}}preferredContextForCommand(e){let t=this.activeContext();if(t)return t;let n=this.anyMarkdownContext();if(n)return this.logStatus("command.context.fallback-used",{action:e,file:n.file.path}),n;this.showError(`${e} requires an open markdown editor.`)}async ensureSourceModeForOverlays(e,t){if(!this.settings.editorIntegrationEnabled)return e;let n=this.markdownModeForView(e.view);if(n!=="preview")return e;this.logStatus("editor.mode.ensure-source.begin",{action:t,file:e.file.path,modeBefore:n}),this.updateStatus("Switching note to Source mode so overlays can render...");try{let a=e.view.leaf,l=a.getViewState();if(l?.type==="markdown"){let h={...l,state:{...l.state??{},mode:"source"},active:!0};await a.setViewState(h),await this.app.workspace.setActiveLeaf(a,!0,!0)}else await this.app.workspace.setActiveLeaf(a,!0,!0)}catch(a){this.logStatus("editor.mode.ensure-source.error",{action:t,file:e.file.path,error:P(a)})}let r=e.view.leaf?.view instanceof p.MarkdownView?e.view.leaf.view:e.view,s=this.contextFromMarkdownView(r,"fallback")??e,c=this.markdownModeForView(s.view);return this.logStatus("editor.mode.ensure-source.end",{action:t,file:s.file.path,modeBefore:n,modeAfter:c}),c==="preview"&&this.updateStatus("Overlays are hidden in Reading view. Switch to Live Preview or Source mode to see colorization and gutter bars."),s}logMissingContext(e,t){let n=Date.now();n-this.lastMissingContextLogAtMs<1500||(this.lastMissingContextLogAtMs=n,this.logStatus("context.missing",{reason:e,...t??{}}))}editorForMarkdownView(e){let t=e.editor;if(!t||typeof t!="object"){this.logStatus("editor.missing-object",{file:e.file?.path??""});return}let n=t;if(typeof n.getValue!="function"||typeof n.getCursor!="function"||typeof n.replaceRange!="function"||typeof n.setCursor!="function"){this.logStatus("editor.missing-methods",{file:e.file?.path??"",hasGetValue:typeof n.getValue=="function",hasGetCursor:typeof n.getCursor=="function",hasReplaceRange:typeof n.replaceRange=="function",hasSetCursor:typeof n.setCursor=="function"});return}return n}hasRenderableEditorForFile(e){for(let t of this.markdownViews())if(t.file?.path===e&&this.markdownModeForView(t)==="source"&&this.editorViewForMarkdownView(t))return!0;return!1}maybeNotifyReadingViewOverlayHidden(e){if(!this.isExtensionEnabled()||!this.settings.editorIntegrationEnabled||this.hasRenderableEditorForFile(e))return;let t=[...new Set(this.markdownViews().filter(n=>n.file?.path===e).map(n=>this.markdownModeForView(n)))];this.logStatus("editor-integration.no-visible-cm-editor",{file:e,modes:t}),this.updateStatus("Analyze completed. Overlays are hidden in Reading view. Open the note in Live Preview or Source mode to see colorization and gutter bars.")}getActiveChunk(e,t,n){if(n.chunks.length===0)return;let r=n.chunks.find(a=>t>=a.charStart&&t<a.analyzedCharEnd);if(r)return r;let s=a=>t<a.charStart?a.charStart-t:t>a.analyzedCharEnd?t-a.analyzedCharEnd:0;return[...n.chunks].sort((a,l)=>{let h=s(a),f=s(l);return h!==f?h-f:a.charStart-l.charStart})[0]}resolveRewriteSpan(e,t,n,r,s){if(n>t)return{start:Math.min(t,n),end:Math.max(t,n)};let c=this.getActiveChunk(e,r,s);if(!c)return;let a=c.rows.filter(l=>Number(l.delta_doc_logPPL_if_removed??0)>=0).find(l=>r>=l.char_start&&r<=l.char_end);if(a)return{start:a.char_start,end:a.char_end}}resolveSelectionOrLineSpan(e,t,n,r){if(n>t)return{start:Math.min(t,n),end:Math.max(t,n)};let s=I(e,{line:r,ch:0}),c=I(e,{line:r+1,ch:0}),a=r+1<Ut(e)?Math.max(s,c-1):e.length;if(!(a<=s))return{start:s,end:a}}isTextOverlayColorizationEnabled(){return this.isExtensionEnabled()?this.settings.renderColorizeText&&this.runtimeColorizationEnabled:!1}async runWithBusyNotice(e,t,n){this.updateStatus(e);let r=this.foregroundBusyOperationCount+1;this.foregroundBusyOperationCount=r,r===1&&(this.foregroundBusyDocKey=n?.docKey,this.foregroundBusyKind=n?.kind??"other");try{return await t()}finally{this.foregroundBusyOperationCount=Math.max(0,this.foregroundBusyOperationCount-1),this.foregroundBusyOperationCount<=0&&(this.foregroundBusyDocKey=void 0,this.foregroundBusyKind=void 0)}}async loadPluginSettings(){let e=await this.loadData();this.settings={...Ke,...e??{}}}async savePluginSettings(){await this.saveData(this.settings),this.isExtensionEnabled()&&(await this.restartBackend(),this.refreshAllDecorations(),this.updateStatusForActiveEditor(),this.refreshControlsView())}},Le=class extends p.PluginSettingTab{constructor(i,e){super(i,e),this.plugin=e}display(){let{containerEl:i}=this;i.empty(),i.createEl("h2",{text:"Binoculars"});let e=this.plugin.getSettings();new p.Setting(i).setName("Enabled").setDesc("Enable/disable Binoculars commands and backend globally.").addToggle(t=>t.setValue(e.enabled).onChange(async n=>{e.enabled=n,await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Editor integration (CM6 overlays/hover/gutter)").setDesc("Enable CodeMirror-based colorization, hover diagnostics, and contribution bars. Disable for open-note stability diagnostics. Requires plugin reload to take effect.").addToggle(t=>t.setValue(e.editorIntegrationEnabled).onChange(async n=>{e.editorIntegrationEnabled=n,this.plugin.resetVisualsDisabledHint(),await this.plugin.savePluginSettings(),this.plugin.postStatus("Editor integration setting saved. Disable/enable the plugin (or restart Obsidian) to apply.")})),new p.Setting(i).setName("Python path").setDesc("Python executable used to launch the persistent bridge backend.").addText(t=>t.setValue(e.backendPythonPath).onChange(async n=>{e.backendPythonPath=n.trim(),await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Bridge script path").setDesc("Path to binoculars_bridge.py. Supports ${vaultRoot} and ${workspaceFolder}.").addText(t=>t.setValue(e.backendBridgeScriptPath).onChange(async n=>{e.backendBridgeScriptPath=n.trim(),await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Config path").setDesc("Path to Binoculars scoring config JSON.").addText(t=>t.setValue(e.configPath).onChange(async n=>{e.configPath=n.trim(),await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Top K").setDesc("Top-k size used for hotspot diagnostics.").addSlider(t=>t.setLimits(1,30,1).setValue(e.topK).setDynamicTooltip().onChange(async n=>{e.topK=n,await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Text max tokens override").setDesc("Optional override for text.max_tokens. Leave blank for profile default.").addText(t=>t.setPlaceholder("null").setValue(e.textMaxTokensOverride===null?"":String(e.textMaxTokensOverride)).onChange(async n=>{let r=n.trim();if(!r)e.textMaxTokensOverride=null;else{let s=Number(r);e.textMaxTokensOverride=Number.isFinite(s)?Math.max(0,Math.trunc(s)):null}await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Observer GGUF path").setDesc("Optional observer model path override.").addText(t=>t.setValue(e.observerGgufPath).onChange(async n=>{e.observerGgufPath=n.trim(),await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Performer GGUF path").setDesc("Optional performer model path override.").addText(t=>t.setValue(e.performerGgufPath).onChange(async n=>{e.performerGgufPath=n.trim(),await this.plugin.savePluginSettings()})),new p.Setting(i).setName("External rewrite LLM enabled").setDesc("Whether rewrite generation may use external OpenAI-compatible LLM when configured.").addToggle(t=>t.setValue(e.externalLlmEnabled).onChange(async n=>{e.externalLlmEnabled=n,await this.plugin.savePluginSettings()})),new p.Setting(i).setName("External rewrite LLM config path").setDesc("Optional explicit path to rewrite LLM config JSON.").addText(t=>t.setValue(e.externalLlmConfigPath).onChange(async n=>{e.externalLlmConfigPath=n.trim(),await this.plugin.savePluginSettings()})),new p.Setting(i).setName("External rewrite endpoint").setDesc("Optional endpoint URL for OpenAI-compatible rewrite model.").addText(t=>t.setValue(e.externalLlmEndpoint).onChange(async n=>{e.externalLlmEndpoint=n.trim(),await this.plugin.savePluginSettings()})),new p.Setting(i).setName("External rewrite model").setDesc("Optional model name for external rewrite LLM.").addText(t=>t.setValue(e.externalLlmModel).onChange(async n=>{e.externalLlmModel=n.trim(),await this.plugin.savePluginSettings()})),new p.Setting(i).setName("External rewrite temperature").setDesc("Optional rewrite temperature override.").addSlider(t=>t.setLimits(0,2,.1).setValue(e.externalLlmTemperature).setDynamicTooltip().onChange(async n=>{e.externalLlmTemperature=n,await this.plugin.savePluginSettings()})),new p.Setting(i).setName("External rewrite max tokens").setDesc("Optional external rewrite max_tokens override.").addText(t=>t.setValue(String(e.externalLlmMaxTokens)).onChange(async n=>{let r=Number(n.trim());Number.isFinite(r)&&r>0&&(e.externalLlmMaxTokens=Math.max(1,Math.trunc(r)),await this.plugin.savePluginSettings())})),new p.Setting(i).setName("Render contribution bars").setDesc("Render per-line contribution bars in editor gutter.").addToggle(t=>t.setValue(e.renderContributionBars).onChange(async n=>{e.renderContributionBars=n,await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Render colorized text").setDesc("Render LOW/HIGH contribution colorization overlays in editor text.").addToggle(t=>t.setValue(e.renderColorizeText).onChange(async n=>{e.renderColorizeText=n,await this.plugin.savePluginSettings()})),new p.Setting(i).setName("Diagnostic logging").setDesc("Write detailed status logs to the plugin status.log file for troubleshooting.").addToggle(t=>t.setValue(e.diagnosticLogging).onChange(async n=>{e.diagnosticLogging=n,await this.plugin.savePluginSettings()}))}};function Y(o){if(!(!o||typeof o!="object"||Array.isArray(o)))return o}function U(o){let i=Number(o);return Number.isFinite(i)?i:void 0}function V(o,i,e){let t=U(o);if(typeof t=="number")return Math.max(i,Math.min(e,Math.trunc(t)))}function Tt(o){let i=Y(o);if(!i)return;let e=U(i.binoculars_score),t=U(i.observer_logPPL),n=U(i.performer_logPPL),r=U(i.cross_logXPPL),s=V(i.transitions,0,Number.MAX_SAFE_INTEGER);if(!(typeof e!="number"||typeof t!="number"||typeof n!="number"||typeof r!="number"||typeof s!="number"))return{binoculars_score:e,observer_logPPL:t,performer_logPPL:n,cross_logXPPL:r,transitions:s}}function Nt(o,i){let e=Y(o);if(!e)return;let t=V(e.char_start,0,i),n=V(e.char_end,0,i);if(typeof t!="number"||typeof n!="number"||n<=t)return;let r={char_start:t,char_end:n},s=V(e.paragraph_id,0,Number.MAX_SAFE_INTEGER);typeof s=="number"&&(r.paragraph_id=s);let c=U(e.logPPL);typeof c=="number"&&(r.logPPL=c);let a=U(e.delta_doc_logPPL_if_removed);return typeof a=="number"&&(r.delta_doc_logPPL_if_removed=a),typeof e.excerpt=="string"&&(r.excerpt=e.excerpt),r}function Vt(o,i){let e=Y(o);if(!e)return;let t=V(e.char_start,0,i),n=V(e.char_end,0,i),r=V(e.analyzed_char_end??e.char_end,0,i);if(typeof t!="number"||typeof r!="number"||r<=t)return;let s=Math.max(r,typeof n=="number"?n:r),a=(Array.isArray(e.rows)?e.rows:[]).map(l=>Nt(l,i)).filter(l=>typeof l<"u");return{charStart:t,charEnd:s,analyzedCharEnd:r,metrics:Tt(e.metrics),rows:a}}function Dt(o,i){let t=(Array.isArray(o.analysis_chunks)?o.analysis_chunks:[]).map(a=>Vt(a,i)).filter(a=>typeof a<"u").sort((a,l)=>a.charStart-l.charStart);if(t.length===0)return;let n=we(t,i),r=V(o.analysis_covered_until,0,i),s=Math.max(n,typeof r=="number"?r:n),c=a=>(Array.isArray(a)?a:[]).map(l=>Y(l)).filter(l=>typeof l<"u").map(l=>({start:V(l.start,0,i),end:V(l.end,0,i)})).filter(l=>typeof l.start=="number"&&typeof l.end=="number").filter(l=>l.end>l.start);return{chunks:t,nextChunkStart:s,stale:!!o.b_score_stale,editedRanges:c(o.edited_ranges),rewriteRanges:c(o.rewrite_ranges),priorLowRanges:c(o.prior_low_ranges),priorHighRanges:c(o.prior_high_ranges),priorChunkB:void 0}}function zt(o,i){return{id:i+1,char_start:o.charStart,char_end:o.charEnd,analyzed_char_end:o.analyzedCharEnd,metrics:o.metrics?{binoculars_score:o.metrics.binoculars_score,observer_logPPL:o.metrics.observer_logPPL,performer_logPPL:o.metrics.performer_logPPL,cross_logXPPL:o.metrics.cross_logXPPL,transitions:o.metrics.transitions}:{},profile:null,rows:o.rows.map(e=>({paragraph_id:e.paragraph_id,char_start:e.char_start,char_end:e.char_end,logPPL:e.logPPL,delta_doc_logPPL_if_removed:e.delta_doc_logPPL_if_removed,excerpt:e.excerpt}))}}function Ot(o,i,e){let t=i.length,n=e?.chunks??[],r=n.length>0,s=r?we(n,t):0,c=r&&s<t,a=[...n].reverse().find(d=>d.metrics)?.metrics,l=a?{binoculars_score:a.binoculars_score,observer_logPPL:a.observer_logPPL,performer_logPPL:a.performer_logPPL,cross_logXPPL:a.cross_logXPPL,transitions:a.transitions}:null,h=a?`B ${J(a.binoculars_score)} | Obs ${J(a.observer_logPPL)} | Cross ${J(a.cross_logXPPL)}`:"",f={baseline_text:i,prev_text:i,has_analysis:r,b_score_stale:!!e?.stale,last_b_score:a?.binoculars_score??null,last_analysis_status_core:h,last_analysis_metrics:l,analyzed_char_end:s,analysis_chunks:n.map((d,g)=>zt(d,g)),analysis_chunk_id_seq:n.length,analysis_covered_until:s,analysis_next_available:c,edited_ranges:(e?.editedRanges??[]).map(d=>({start:d.start,end:d.end})),rewrite_ranges:(e?.rewriteRanges??[]).map(d=>({start:d.start,end:d.end})),prior_low_ranges:(e?.priorLowRanges??[]).map(d=>({start:d.start,end:d.end})),prior_high_ranges:(e?.priorHighRanges??[]).map(d=>({start:d.start,end:d.end}))};return{binoculars_gui_state:!0,version:1,saved_at:new Date().toISOString().replace(/\.\d{3}Z$/,"Z"),document_path:E.resolve(o),document_basename:E.basename(o),text_sha256:te(i),state:f}}function de(o){return{charStart:o.chunk.char_start,charEnd:o.chunk.char_end,analyzedCharEnd:o.chunk.analyzed_char_end,metrics:o.chunk.metrics,rows:o.paragraph_profile?.rows??[]}}function ke(o,i){let e=o.chunks.filter(t=>t.analyzedCharEnd<=i.charStart||t.charStart>=i.analyzedCharEnd);e.push(i),e.sort((t,n)=>t.charStart-n.charStart),o.chunks=e}function ee(o,i){if(!o||!o.chunks.length)return;let e=0,t;for(let n of o.chunks){if(!n.metrics)continue;let r=Math.max(n.charStart,i.charStart),s=Math.min(n.analyzedCharEnd,i.analyzedCharEnd),c=Math.max(0,s-r);c<=0||c<e||(e=c,t=n.metrics.binoculars_score)}return t}function he(o,i,e,t){let n=[],r=[],s=at(o,t);for(let c of o.chunks){let a=Math.max(c.charStart,i.charStart),l=Math.min(c.analyzedCharEnd,i.analyzedCharEnd);if(!(l<=a))for(let h of c.rows){if(!s.has(h))continue;let f=Math.max(0,Math.min(e,Number(h.char_start??0))),d=Math.max(f,Math.min(e,Number(h.char_end??f)));if(d<=f)continue;let g=Math.max(a,f),u=Math.min(l,d);if(u<=g)continue;Number(h.delta_doc_logPPL_if_removed??0)>=0?n.push({start:g,end:u}):r.push({start:g,end:u})}}return{low:R(n),high:R(r)}}function R(o){if(o.length===0)return[];let i=[...o].filter(t=>Number.isFinite(t.start)&&Number.isFinite(t.end)&&t.end>t.start).sort((t,n)=>t.start-n.start);if(i.length===0)return[];let e=[{start:i[0].start,end:i[0].end}];for(let t=1;t<i.length;t+=1){let n=i[t],r=e[e.length-1];n.start<=r.end?r.end=Math.max(r.end,n.end):e.push({start:n.start,end:n.end})}return e}function ot(o){return[...o].filter(i=>Number.isFinite(i.start)&&Number.isFinite(i.end)&&i.end>i.start).sort((i,e)=>i.start-e.start||i.end-e.end)}function tt(o,i){let e=Math.max(0,Math.trunc(i)),t,n=Number.MAX_SAFE_INTEGER;for(let r of ot(o)){if(e<r.start||e>=r.end)continue;let s=r.end-r.start;(!t||s<n)&&(t=r,n=s)}return t}function It(o,i,e){let t=Math.max(0,Math.trunc(i)),n=Math.max(t,Math.trunc(e));if(n<=t)return!1;for(let r of ot(o)){let s=Math.max(t,r.start);if(Math.min(n,r.end)>s)return!0}return!1}function $t(o,i,e,t){let n=Math.max(0,e-i),r=t-n,s=[];for(let c of o){if(c.end<=i){s.push({start:c.start,end:c.end});continue}if(c.start>=e){s.push({start:c.start+r,end:c.end+r});continue}let a=Math.min(c.start,i),l=c.end>e?c.end+r:i+t,h=Math.max(i+t,l);h>a&&s.push({start:a,end:h})}return R(s)}function _e(o,i,e,t){let n=Math.max(0,o),r=Math.max(0,i),s=Math.max(r,e),c=t-(s-r);return n<r?n:n>=s?n+c:r}function Ee(o,i,e,t,n){let r=_e(o,e,t,n),s=_e(i,e,t,n);if(!(s<=r))return{start:r,end:s}}function qt(o,i,e){if(!i||i.length===0||o.chunks.length===0){o.nextChunkStart=Math.max(0,Math.min(e,o.nextChunkStart));return}let t=[...i].sort((c,a)=>c.rangeOffset-a.rangeOffset),n=o.chunks.map(c=>({charStart:c.charStart,charEnd:c.charEnd,analyzedCharEnd:c.analyzedCharEnd,metrics:c.metrics,rows:c.rows.map(a=>({...a}))})),r=o.nextChunkStart,s=0;for(let c of t){let a=Math.max(0,c.rangeOffset),l=Math.max(a,c.rangeOffset+Math.max(0,c.rangeLength)),h=Math.max(0,a+s),f=Math.max(h,l+s),d=c.text.length;r=_e(r,h,f,d);let g=[];for(let u of n){let m=Ee(u.charStart,u.charEnd,h,f,d),b=Ee(u.charStart,u.analyzedCharEnd,h,f,d);if(!m||!b)continue;let y=m.start,v=Math.max(y,b.end),M=Math.max(m.end,v);if(M<=y)continue;let F=u.rows.map(C=>{let L=Ee(C.char_start,C.char_end,h,f,d);if(!L)return;let w=Math.max(y,L.start),A=Math.min(M,L.end);if(!(A<=w))return{...C,char_start:w,char_end:A}}).filter(C=>typeof C<"u");g.push({...u,charStart:y,charEnd:M,analyzedCharEnd:v,rows:F})}n=g,s+=d-(l-a)}n.sort((c,a)=>c.charStart-a.charStart),o.chunks=n,o.nextChunkStart=Math.max(0,Math.min(e,r))}function Be(o,i,e){if(!i||i.length===0)return o;let t=[...i].sort((s,c)=>s.rangeOffset-c.rangeOffset),n=0,r=R(o);for(let s of t){let c=Math.max(0,s.rangeOffset),a=Math.max(c,s.rangeOffset+Math.max(0,s.rangeLength)),l=Math.max(0,c+n),h=Math.max(l,a+n),f=s.text.length;r=$t(r,l,h,f),e&&f>0&&(r.push({start:l,end:l+f}),r=R(r)),n+=f-(a-c)}return r}function Ht(o,i){return Be(o,i,!0)}function jt(o,i){return Be(o,i,!1)}function nt(o,i){return Be(o,i,!1)}function Kt(o,i){let e,t=Number.MAX_SAFE_INTEGER;for(let n of o.chunks)for(let r of n.rows){let s=Math.max(0,Number(r.char_start??0)),c=Math.max(s,Number(r.char_end??s));if(i<s||i>=c)continue;let a=c-s;(!e||a<t)&&(e={chunk:n,row:r},t=a)}return e}function Gt(o,i,e){let t,n=-1;for(let r of o.chunks)for(let s of r.rows){let c=Math.max(0,Number(s.char_start??0));if(Math.max(c,Number(s.char_end??c))<=i||c>=e)continue;let l=Math.abs(Number(s.delta_doc_logPPL_if_removed??0));(!t||l>n)&&(t={chunk:r,row:s},n=l)}return t}function at(o,i){let e=[];for(let r of o.chunks)for(let s of r.rows)e.push({row:s,delta:Number(s.delta_doc_logPPL_if_removed??0)});if(e.length===0)return new Set;let t=e.filter(r=>Number.isFinite(r.delta)&&r.delta>=0).sort((r,s)=>s.delta-r.delta).slice(0,i).map(r=>r.row),n=e.filter(r=>Number.isFinite(r.delta)&&r.delta<0).sort((r,s)=>r.delta-s.delta).slice(0,i).map(r=>r.row);return new Set([...t,...n])}function Fe(o){if(o.length===0)return[];let i=[...o].sort((t,n)=>t.start-n.start),e=[i[0]];for(let t=1;t<i.length;t+=1){let n=e[e.length-1],r=i[t];r.start<=n.end?n.end=Math.max(n.end,r.end):e.push({start:r.start,end:r.end})}return e}function rt(o,i){let e=[],t=0;for(let n of o)n.start>t&&e.push({start:t,end:n.start}),t=Math.max(t,n.end);return t<i&&e.push({start:t,end:i}),e.filter(n=>n.end>n.start)}function we(o,i){let e=Fe(o.map(n=>({start:Math.max(0,Math.min(i,n.charStart)),end:Math.max(0,Math.min(i,n.analyzedCharEnd))})).filter(n=>n.end>n.start)),t=0;for(let n of e){if(n.start>t)break;t=Math.max(t,n.end)}return Math.max(0,Math.min(i,t))}function te(o){return it.createHash("sha256").update(o,"utf8").digest("hex")}function P(o){if(o instanceof O)return{name:o.name,message:o.message,code:o.code??"",method:o.method??"",details:o.details??{},stack:o.stack??""};if(o instanceof Error)return{name:o.name,message:o.message,stack:o.stack??""};if(typeof o=="string")return o;try{return JSON.stringify(o)}catch{return String(o)}}function J(o){return Number.isFinite(o)?o.toFixed(Ae):"n/a"}function q(o){return Number.isFinite(o)?`${o>=0?"+":""}${o.toFixed(Ae)}`:"n/a"}function Wt(o,i){if(typeof o!="number"||Number.isNaN(o))return"rewrite option";let e=typeof i=="number"&&Number.isFinite(i)?` (${q(i)})`:"";return`approx B ${o.toFixed(Ae)}${e}`}function xe(o){return o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function G(o,i){let e=Math.max(0,Math.min(o.length,Math.trunc(i)));return ge(o,e).line+1}function Ut(o){if(!o)return 1;let i=1;for(let e=0;e<o.length;e+=1)o.charCodeAt(e)===10&&(i+=1);return i}function ge(o,i){let e=Math.max(0,Math.min(o.length,i)),t=o.slice(0,e).split(`
`),n=Math.max(0,t.length-1),r=t[t.length-1]?.length??0;return{line:n,ch:r}}function I(o,i){let e=o.split(`
`),t=0,n=Math.max(0,Math.min(e.length-1,i.line));for(let r=0;r<n;r+=1)t+=e[r].length+1;return Math.max(0,Math.min(o.length,t+Math.max(0,i.ch)))}
